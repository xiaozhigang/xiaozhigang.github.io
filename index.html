<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
<meta property="og:type" content="website">
<meta property="og:title" content="xiaozhigang">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="xiaozhigang">
<meta property="og:description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="xiaozhigang">
<meta property="article:tag" content="java,ä¸­é—´ä»¶ï¼Œåç«¯ï¼Œå¤§æ•°æ®ï¼Œai">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>xiaozhigang</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">xiaozhigang</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">é•¿é£ç ´æµªä¼šæœ‰æ—¶ï¼Œç›´æŒ‚äº‘å¸†æµæ²§æµ·ã€‚</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">xiaozhigang</p>
  <div class="site-description" itemprop="description">æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">46</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/09/06/Untitled/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaozhigang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaozhigang">
      <meta itemprop="description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | xiaozhigang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/09/06/Untitled/" class="post-title-link" itemprop="url">æœªå‘½å</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-09-06 16:36:29 / ä¿®æ”¹æ—¶é—´ï¼š16:44:45" itemprop="dateCreated datePublished" datetime="2025-09-06T16:36:29+08:00">2025-09-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MetaGPT-é‡å†™å­¦ä¹ è·¯çº¿å›¾"><a href="#MetaGPT-é‡å†™å­¦ä¹ è·¯çº¿å›¾" class="headerlink" title="MetaGPT é‡å†™å­¦ä¹ è·¯çº¿å›¾"></a>MetaGPT é‡å†™å­¦ä¹ è·¯çº¿å›¾</h1><pre class="mermaid">flowchart TD
    A[Step-1: ç¯å¢ƒå‡†å¤‡] --> B[Step-2: æœ€å° Agent]
    B --> C[Step-3: å¤šè§’è‰²åä½œ]
    C --> D[Step-4: ä»»åŠ¡åˆ†è§£ä¸æ‰§è¡Œæµ]
    D --> E[Step-5: å·¥å…·è°ƒç”¨ä¸è®°å¿†æ¨¡å—]
    E --> F[Step-6: é¡¹ç›®çº§åº”ç”¨åœºæ™¯]

    subgraph Step-1: ç¯å¢ƒå‡†å¤‡
        A1[ç†Ÿæ‚‰ Python åŸºç¡€]
        A2[äº†è§£ Asyncio / å¹¶å‘]
        A3[å®‰è£…ä¾èµ– & ç†Ÿæ‚‰ä»£ç ç»“æ„]
    end

    subgraph Step-2: æœ€å° Agent
        B1[å®ç°ç®€å•è¾“å…¥ â†’ è¾“å‡º]
        B2[ç†è§£ Prompt æ¨¡æ¿åŒ–]
    end

    subgraph Step-3: å¤šè§’è‰²åä½œ
        C1[è§’è‰²è®¾å®š: PM / Eng / QA]
        C2[Agent ä¹‹é—´æ¶ˆæ¯ä¼ é€’]
    end

    subgraph Step-4: ä»»åŠ¡åˆ†è§£ä¸æ‰§è¡Œæµ
        D1[å­¦ä¹  Workflow / Pipeline]
        D2[å®ç°ä»»åŠ¡åˆ†è§£å™¨]
        D3[è°ƒåº¦å¤šä¸ª Agent ååŒ]
    end

    subgraph Step 5: å·¥å…·è°ƒç”¨ä¸è®°å¿†æ¨¡å—
        E1[è°ƒç”¨å¤–éƒ¨ API / æœç´¢]
        E2[é›†æˆæ•°æ®åº“ / çŸ¥è¯†åº“]
        E3[å®ç°çŸ­æœŸ & é•¿æœŸè®°å¿†]
    end

    subgraph Step-6: é¡¹ç›®çº§åº”ç”¨åœºæ™¯
        F1[å†™ä¸€ä¸ªéœ€æ±‚ â†’ äº§å‡ºä»£ç  Demo]
        F2[æ‰©å±•åˆ°å¤šä»»åŠ¡å¹¶è¡Œ]
        F3[ä¼˜åŒ–æ—¥å¿— & å¯è§†åŒ–ç›‘æ§]
    end</pre>











<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">mindmap</span><br><span class="line">  root((MetaGPT é‡å†™å­¦ä¹ è·¯çº¿))</span><br><span class="line">    0. ç›®æ ‡ä¸èŒƒå›´</span><br><span class="line">      å®šä¹‰ç›®æ ‡: å¤ç°ä¸€ä¸ªæœ€å°çš„å¤šæ™ºèƒ½ä½“åä½œæ¡†æ¶</span><br><span class="line">      åŸºå‡†ä»»åŠ¡: &quot;åšä¸€ä¸ªè®¡ç®—å™¨&quot; â†’ PRD â†’ ä»£ç  â†’ è¿è¡Œ</span><br><span class="line">      äº§å‡º: è·‘é€šç«¯åˆ°ç«¯æœ€å°æ¡ˆä¾‹</span><br><span class="line">    1. ç¯å¢ƒ &amp; åŸºç¡€è®¾æ–½</span><br><span class="line">      è¯­è¨€: Python 3.10+</span><br><span class="line">      ä¾èµ–: asyncio, httpx/requests, pydantic, faiss/duckdb(å¯é€‰)</span><br><span class="line">      ç›®å½•: src/  tests/  examples/  plugins/</span><br><span class="line">      é…ç½®: .env  settings.py  æ—¥å¿—</span><br><span class="line">    2. æœ€å° Agent MVP</span><br><span class="line">      Agentç±»: name, role, prompt</span><br><span class="line">      LLMæŠ½è±¡: LLMClient.call(prompt, tools?)</span><br><span class="line">      åŠ¨ä½œ: act(input) â†’ output</span><br><span class="line">      Demo: å›ç­”/æ€»ç»“/æ”¹å†™</span><br><span class="line">      éªŒæ”¶: CLI ç¤ºä¾‹ + å•æµ‹</span><br><span class="line">    3. è§’è‰²ç³»ç»Ÿ (Role)</span><br><span class="line">      RoleåŸºç±»: receive() â†’ think() â†’ act() â†’ produce()</span><br><span class="line">      æ¶ˆæ¯æ¨¡å‹: Message&#123;sender, role, content, type&#125;</span><br><span class="line">      å…·ä½“è§’è‰²: PM, Engineer, QA(å¯å…ˆ2ä¸ª)</span><br><span class="line">      éªŒæ”¶: PM äº§å‡º PRD â†’ Eng äº§å‡ºä»£ç </span><br><span class="line">    4. è°ƒåº¦å™¨ Team</span><br><span class="line">      Team: agents[], run(goal)</span><br><span class="line">      æµç¨‹: ä¸²è¡Œ/å¹¶è¡Œ/å¾ªç¯(é‡è¯•/è¯„å®¡)</span><br><span class="line">      é€šä¿¡: äº‹ä»¶æ€»çº¿ pub/sub æˆ–é»‘æ¿(å…±äº«çŠ¶æ€)</span><br><span class="line">      éªŒæ”¶: ç›®æ ‡â†’PRDâ†’ä»£ç  çš„ç«¯åˆ°ç«¯è¾“å‡º</span><br><span class="line">    5. SOP / Workflow</span><br><span class="line">      StepèŠ‚ç‚¹: è¾“å…¥/æç¤º/è¾“å‡º Schema</span><br><span class="line">      ç¼–æ’: Pipeline/Graph(æœ‰å‘å›¾)</span><br><span class="line">      å¯é‡æ”¾: trace/æ—¥å¿—/å¿«ç…§</span><br><span class="line">      éªŒæ”¶: åŒä¸€ SOP å¯å¤ç”¨åœ¨ä¸åŒä»»åŠ¡</span><br><span class="line">    6. è®°å¿†å±‚ Memory</span><br><span class="line">      çŸ­æœŸ: ä¼šè¯çª—å£/å¯¹è¯å†å²è£å‰ª</span><br><span class="line">      é•¿æœŸ: å‘é‡åº“(FAISS) + æ–‡æ¡£åˆ†å—</span><br><span class="line">      RAG: Retriever + Chunker + Ranker</span><br><span class="line">      éªŒæ”¶: èƒ½å›å¿†å†å²ä¸æ£€ç´¢çŸ¥è¯†</span><br><span class="line">    7. å·¥å…· &amp; æ‰§è¡Œå™¨</span><br><span class="line">      Toolæ¥å£: name, schema, run()</span><br><span class="line">      å¸¸ç”¨å·¥å…·: web_search, code_exec, db_query</span><br><span class="line">      æ‰§è¡Œæ²™ç›’: è¶…æ—¶/èµ„æºé™é¢/docker(å¯é€‰)</span><br><span class="line">      å®‰å…¨: ç™½åå•, é€Ÿç‡é™åˆ¶, é¢„ç®—</span><br><span class="line">    8. å¤šæ™ºèƒ½ä½“åä½œ</span><br><span class="line">      åè®®: ä»»åŠ¡å¡/å·¥å•, æŠ•ç¥¨/ä»²è£</span><br><span class="line">      æ‹“æ‰‘: PMâ†’ENGâ†’QAâ†’Reviewer</span><br><span class="line">      åŒæ­¥: é»‘æ¿/æ¶ˆæ¯é˜Ÿåˆ—</span><br><span class="line">      éªŒæ”¶: å¤š Agent åä½œå®Œæˆå¤æ‚ä»»åŠ¡</span><br><span class="line">    9. è§‚æµ‹ &amp; è¯„æµ‹</span><br><span class="line">      æ—¥å¿—: ç»“æ„åŒ–æ—¥å¿— + TraceID</span><br><span class="line">      æŒ‡æ ‡: tokens/latency/cost/success rate</span><br><span class="line">      å¯è§†åŒ–: trace graph/è°ƒç”¨é“¾</span><br><span class="line">      è¯„æµ‹: åŸºå‡†ä»»åŠ¡é€šè¿‡ç‡/å›å½’é›†</span><br><span class="line">    10. é¡¹ç›®åŒ–è½åœ°</span><br><span class="line">      æ¥å£: CLI/HTTP(gRPC/REST)</span><br><span class="line">      é…ç½®: æ’ä»¶æ³¨å†Œ/è§’è‰²æ¨¡æ¿/å·¥å…·æ¸…å•</span><br><span class="line">      æŒä¹…åŒ–: sqlite/redis(é˜Ÿåˆ—/ç¼“å­˜)</span><br><span class="line">      éƒ¨ç½²: docker compose</span><br><span class="line">    11. æ‰©å±•æ–¹å‘</span><br><span class="line">      è®¡åˆ’å™¨: åæ€/è‡ªçº é”™/è®¡åˆ’-æ‰§è¡Œ-åæ€</span><br><span class="line">      ç¼–æ’: å…¼å®¹ LangGraph/CrewAI</span><br><span class="line">      ç¼“å­˜: prompt/æ£€ç´¢/ç»“æœç¼“å­˜</span><br><span class="line">      æˆæœ¬æ§åˆ¶: é¢„ç®—/é…é¢/é™çº§</span><br><span class="line">    12. é‡Œç¨‹ç¢‘(ç¤ºä¾‹)</span><br><span class="line">      Week1: æœ€å°Agent + CLI</span><br><span class="line">      Week2: è§’è‰²ç³»ç»Ÿ + Team</span><br><span class="line">      Week3: SOP + Memory</span><br><span class="line">      Week4: å·¥å…· + åä½œ</span><br><span class="line">      Week5: è§‚æµ‹ + é¡¹ç›®åŒ–</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>mindmap<br>  root((MetaGPT é‡å†™å­¦ä¹ è·¯çº¿))<br>    0. ç›®æ ‡ä¸èŒƒå›´<br>            å®šä¹‰ç›®æ ‡: å¤ç°ä¸€ä¸ªæœ€å°çš„å¤šæ™ºèƒ½ä½“åä½œæ¡†æ¶<br>            åŸºå‡†ä»»åŠ¡: â€œåšä¸€ä¸ªè®¡ç®—å™¨â€ â†’ PRD â†’ ä»£ç  â†’ è¿è¡Œ<br>            äº§å‡º: è·‘é€šç«¯åˆ°ç«¯æœ€å°æ¡ˆä¾‹<br>        1. ç¯å¢ƒ &amp; åŸºç¡€è®¾æ–½<br>                  è¯­è¨€: Python 3.10+<br>                  ä¾èµ–: asyncio, httpx&#x2F;requests, pydantic, faiss&#x2F;duckdb(å¯é€‰)<br>                  ç›®å½•: src&#x2F;  tests&#x2F;  examples&#x2F;  plugins&#x2F;<br>                  é…ç½®: .env  settings.py  æ—¥å¿—<br>            2. æœ€å° Agent MVP<br>                        Agentç±»: name, role, prompt<br>                        LLMæŠ½è±¡: LLMClient.call(prompt, tools?)<br>                        åŠ¨ä½œ: act(input) â†’ output<br>                        Demo: å›ç­”&#x2F;æ€»ç»“&#x2F;æ”¹å†™<br>                        éªŒæ”¶: CLI ç¤ºä¾‹ + å•æµ‹<br>                3. è§’è‰²ç³»ç»Ÿ (Role)<br>                              RoleåŸºç±»: receive() â†’ think() â†’ act() â†’ produce()<br>                              æ¶ˆæ¯æ¨¡å‹: Message{sender, role, content, type}<br>                              å…·ä½“è§’è‰²: PM, Engineer, QA(å¯å…ˆ2ä¸ª)<br>                              éªŒæ”¶: PM äº§å‡º PRD â†’ Eng äº§å‡ºä»£ç <br>                    4. è°ƒåº¦å™¨ Team<br>                                    Team: agents[], run(goal)<br>                                    æµç¨‹: ä¸²è¡Œ&#x2F;å¹¶è¡Œ&#x2F;å¾ªç¯(é‡è¯•&#x2F;è¯„å®¡)<br>                                    é€šä¿¡: äº‹ä»¶æ€»çº¿ pub&#x2F;sub æˆ–é»‘æ¿(å…±äº«çŠ¶æ€)<br>                                    éªŒæ”¶: ç›®æ ‡â†’PRDâ†’ä»£ç  çš„ç«¯åˆ°ç«¯è¾“å‡º<br>                        5. SOP &#x2F; Workflow<br>                                          StepèŠ‚ç‚¹: è¾“å…¥&#x2F;æç¤º&#x2F;è¾“å‡º Schema<br>                                          ç¼–æ’: Pipeline&#x2F;Graph(æœ‰å‘å›¾)<br>                                          å¯é‡æ”¾: trace&#x2F;æ—¥å¿—&#x2F;å¿«ç…§<br>                                          éªŒæ”¶: åŒä¸€ SOP å¯å¤ç”¨åœ¨ä¸åŒä»»åŠ¡<br>                            6. è®°å¿†å±‚ Memory<br>                                                çŸ­æœŸ: ä¼šè¯çª—å£&#x2F;å¯¹è¯å†å²è£å‰ª<br>                                                é•¿æœŸ: å‘é‡åº“(FAISS) + æ–‡æ¡£åˆ†å—<br>                                                RAG: Retriever + Chunker + Ranker<br>                                                éªŒæ”¶: èƒ½å›å¿†å†å²ä¸æ£€ç´¢çŸ¥è¯†<br>                                7. å·¥å…· &amp; æ‰§è¡Œå™¨<br>                                                      Toolæ¥å£: name, schema, run()<br>                                                      å¸¸ç”¨å·¥å…·: web_search, code_exec, db_query<br>                                                      æ‰§è¡Œæ²™ç›’: è¶…æ—¶&#x2F;èµ„æºé™é¢&#x2F;docker(å¯é€‰)<br>                                                      å®‰å…¨: ç™½åå•, é€Ÿç‡é™åˆ¶, é¢„ç®—<br>                                    8. å¤šæ™ºèƒ½ä½“åä½œ<br>                                                            åè®®: ä»»åŠ¡å¡&#x2F;å·¥å•, æŠ•ç¥¨&#x2F;ä»²è£<br>                                                            æ‹“æ‰‘: PMâ†’ENGâ†’QAâ†’Reviewer<br>                                                            åŒæ­¥: é»‘æ¿&#x2F;æ¶ˆæ¯é˜Ÿåˆ—<br>                                                            éªŒæ”¶: å¤š Agent åä½œå®Œæˆå¤æ‚ä»»åŠ¡<br>                                        9. è§‚æµ‹ &amp; è¯„æµ‹<br>                                                                  æ—¥å¿—: ç»“æ„åŒ–æ—¥å¿— + TraceID<br>                                                                  æŒ‡æ ‡: tokens&#x2F;latency&#x2F;cost&#x2F;success rate<br>                                                                  å¯è§†åŒ–: trace graph&#x2F;è°ƒç”¨é“¾<br>                                                                  è¯„æµ‹: åŸºå‡†ä»»åŠ¡é€šè¿‡ç‡&#x2F;å›å½’é›†<br>                                            10. é¡¹ç›®åŒ–è½åœ°<br>                                                                        æ¥å£: CLI&#x2F;HTTP(gRPC&#x2F;REST)<br>                                                                        é…ç½®: æ’ä»¶æ³¨å†Œ&#x2F;è§’è‰²æ¨¡æ¿&#x2F;å·¥å…·æ¸…å•<br>                                                                        æŒä¹…åŒ–: sqlite&#x2F;redis(é˜Ÿåˆ—&#x2F;ç¼“å­˜)<br>                                                                        éƒ¨ç½²: docker compose<br>                                                11. æ‰©å±•æ–¹å‘<br>                                                                              è®¡åˆ’å™¨: åæ€&#x2F;è‡ªçº é”™&#x2F;è®¡åˆ’-æ‰§è¡Œ-åæ€<br>                                                                              ç¼–æ’: å…¼å®¹ LangGraph&#x2F;CrewAI<br>                                                                              ç¼“å­˜: prompt&#x2F;æ£€ç´¢&#x2F;ç»“æœç¼“å­˜<br>                                                                              æˆæœ¬æ§åˆ¶: é¢„ç®—&#x2F;é…é¢&#x2F;é™çº§<br>                                                    12. é‡Œç¨‹ç¢‘(ç¤ºä¾‹)<br>                                                                                    Week1: æœ€å°Agent + CLI<br>                                                                                    Week2: è§’è‰²ç³»ç»Ÿ + Team<br>                                                                                    Week3: SOP + Memory<br>                                                                                    Week4: å·¥å…· + åä½œ<br>                                                                                    Week5: è§‚æµ‹ + é¡¹ç›®åŒ–</p>
<p>mindmap<br>  root((MetaGPT é‡å†™å­¦ä¹ è·¯çº¿))<br>    0. ç›®æ ‡ä¸èŒƒå›´<br>      å®šä¹‰ç›®æ ‡: å¤ç°ä¸€ä¸ªæœ€å°çš„å¤šæ™ºèƒ½ä½“åä½œæ¡†æ¶<br>      åŸºå‡†ä»»åŠ¡: â€œåšä¸€ä¸ªè®¡ç®—å™¨â€ â†’ PRD â†’ ä»£ç  â†’ è¿è¡Œ<br>      äº§å‡º: è·‘é€šç«¯åˆ°ç«¯æœ€å°æ¡ˆä¾‹<br>    1. ç¯å¢ƒ &amp; åŸºç¡€è®¾æ–½<br>      è¯­è¨€: Python 3.10+<br>      ä¾èµ–: asyncio, httpx&#x2F;requests, pydantic, faiss&#x2F;duckdb(å¯é€‰)<br>      ç›®å½•: src&#x2F;  tests&#x2F;  examples&#x2F;  plugins&#x2F;<br>      é…ç½®: .env  settings.py  æ—¥å¿—<br>    2. æœ€å° Agent MVP<br>      Agentç±»: name, role, prompt<br>      LLMæŠ½è±¡: LLMClient.call(prompt, tools?)<br>      åŠ¨ä½œ: act(input) â†’ output<br>      Demo: å›ç­”&#x2F;æ€»ç»“&#x2F;æ”¹å†™<br>      éªŒæ”¶: CLI ç¤ºä¾‹ + å•æµ‹<br>    3. è§’è‰²ç³»ç»Ÿ (Role)<br>      RoleåŸºç±»: receive() â†’ think() â†’ act() â†’ produce()<br>      æ¶ˆæ¯æ¨¡å‹: Message{sender, role, content, type}<br>      å…·ä½“è§’è‰²: PM, Engineer, QA(å¯å…ˆ2ä¸ª)<br>      éªŒæ”¶: PM äº§å‡º PRD â†’ Eng äº§å‡ºä»£ç <br>    4. è°ƒåº¦å™¨ Team<br>      Team: agents[], run(goal)<br>      æµç¨‹: ä¸²è¡Œ&#x2F;å¹¶è¡Œ&#x2F;å¾ªç¯(é‡è¯•&#x2F;è¯„å®¡)<br>      é€šä¿¡: äº‹ä»¶æ€»çº¿ pub&#x2F;sub æˆ–é»‘æ¿(å…±äº«çŠ¶æ€)<br>      éªŒæ”¶: ç›®æ ‡â†’PRDâ†’ä»£ç  çš„ç«¯åˆ°ç«¯è¾“å‡º<br>    5. SOP &#x2F; Workflow<br>      StepèŠ‚ç‚¹: è¾“å…¥&#x2F;æç¤º&#x2F;è¾“å‡º Schema<br>      ç¼–æ’: Pipeline&#x2F;Graph(æœ‰å‘å›¾)<br>      å¯é‡æ”¾: trace&#x2F;æ—¥å¿—&#x2F;å¿«ç…§<br>      éªŒæ”¶: åŒä¸€ SOP å¯å¤ç”¨åœ¨ä¸åŒä»»åŠ¡<br>    6. è®°å¿†å±‚ Memory<br>      çŸ­æœŸ: ä¼šè¯çª—å£&#x2F;å¯¹è¯å†å²è£å‰ª<br>      é•¿æœŸ: å‘é‡åº“(FAISS) + æ–‡æ¡£åˆ†å—<br>      RAG: Retriever + Chunker + Ranker<br>      éªŒæ”¶: èƒ½å›å¿†å†å²ä¸æ£€ç´¢çŸ¥è¯†<br>    7. å·¥å…· &amp; æ‰§è¡Œå™¨<br>      Toolæ¥å£: name, schema, run()<br>      å¸¸ç”¨å·¥å…·: web_search, code_exec, db_query<br>      æ‰§è¡Œæ²™ç›’: è¶…æ—¶&#x2F;èµ„æºé™é¢&#x2F;docker(å¯é€‰)<br>      å®‰å…¨: ç™½åå•, é€Ÿç‡é™åˆ¶, é¢„ç®—<br>    8. å¤šæ™ºèƒ½ä½“åä½œ<br>      åè®®: ä»»åŠ¡å¡&#x2F;å·¥å•, æŠ•ç¥¨&#x2F;ä»²è£<br>      æ‹“æ‰‘: PMâ†’ENGâ†’QAâ†’Reviewer<br>      åŒæ­¥: é»‘æ¿&#x2F;æ¶ˆæ¯é˜Ÿåˆ—<br>      éªŒæ”¶: å¤š Agent åä½œå®Œæˆå¤æ‚ä»»åŠ¡<br>    9. è§‚æµ‹ &amp; è¯„æµ‹<br>      æ—¥å¿—: ç»“æ„åŒ–æ—¥å¿— + TraceID<br>      æŒ‡æ ‡: tokens&#x2F;latency&#x2F;cost&#x2F;success rate<br>      å¯è§†åŒ–: trace graph&#x2F;è°ƒç”¨é“¾<br>      è¯„æµ‹: åŸºå‡†ä»»åŠ¡é€šè¿‡ç‡&#x2F;å›å½’é›†<br>    10. é¡¹ç›®åŒ–è½åœ°<br>      æ¥å£: CLI&#x2F;HTTP(gRPC&#x2F;REST)<br>      é…ç½®: æ’ä»¶æ³¨å†Œ&#x2F;è§’è‰²æ¨¡æ¿&#x2F;å·¥å…·æ¸…å•<br>      æŒä¹…åŒ–: sqlite&#x2F;redis(é˜Ÿåˆ—&#x2F;ç¼“å­˜)<br>      éƒ¨ç½²: docker compose<br>    11. æ‰©å±•æ–¹å‘<br>      è®¡åˆ’å™¨: åæ€&#x2F;è‡ªçº é”™&#x2F;è®¡åˆ’-æ‰§è¡Œ-åæ€<br>      ç¼–æ’: å…¼å®¹ LangGraph&#x2F;CrewAI<br>      ç¼“å­˜: prompt&#x2F;æ£€ç´¢&#x2F;ç»“æœç¼“å­˜<br>      æˆæœ¬æ§åˆ¶: é¢„ç®—&#x2F;é…é¢&#x2F;é™çº§<br>    12. é‡Œç¨‹ç¢‘(ç¤ºä¾‹)<br>      Week1: æœ€å°Agent + CLI<br>      Week2: è§’è‰²ç³»ç»Ÿ + Team<br>      Week3: SOP + Memory<br>      Week4: å·¥å…· + åä½œ<br>      Week5: è§‚æµ‹ + é¡¹ç›®åŒ–</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/19/RAG-%E5%BC%BA%E5%8C%96%E7%B4%A2%E5%BC%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaozhigang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaozhigang">
      <meta itemprop="description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | xiaozhigang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/19/RAG-%E5%BC%BA%E5%8C%96%E7%B4%A2%E5%BC%95/" class="post-title-link" itemprop="url">RAG-è·¯ç”±é€‰æ‹©</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-19 15:28:52" itemprop="dateCreated datePublished" datetime="2025-07-19T15:28:52+08:00">2025-07-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RAG/" itemprop="url" rel="index"><span itemprop="name">RAG</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h3><p>â€‹	RAGçš„ä¸»æµç¨‹å…¶å®æ¯”è¾ƒç®€å•ï¼Œæµç¨‹å‰é¢å·²ç»è¯´è¿‡äº†ï¼Œç®€å•çœ‹ä¸€ä¸‹ä¸‹é¢çš„å›¾äº†è§£ä¸€ä¸‹å°±è¡Œã€‚</p>
<p><img src="/../images/rag-ext/rag_base_uml.png" alt="image-20250621160518166"></p>
<p>â€‹	ä»ä¸Šé¢çš„å›¾ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒRAGåœ¨å›ç­”ç”¨æˆ·é—®é¢˜çš„æ—¶å€™ï¼Œå‘é‡æ•°æ®åº“çš„äº¤äº’å¼éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œå¦‚æœæˆ‘ä»¬èƒ½æé«˜å‘é‡åº“çš„å¬å›è´¨é‡ä¹Ÿå°±èƒ½æé«˜æ•´ä¸ªç­”æ¡ˆç”Ÿæˆçš„è´¨é‡ã€‚</p>
<h3 id="å¼ºåŒ–ç´¢å¼•"><a href="#å¼ºåŒ–ç´¢å¼•" class="headerlink" title="å¼ºåŒ–ç´¢å¼•"></a>å¼ºåŒ–ç´¢å¼•</h3><p>â€‹	ç°åœ¨æˆ‘ä»¬çŸ¥é“æé«˜å‘é‡åº“çš„å¬å›è´¨é‡èƒ½æé«˜æ•´ä¸ªæé—®ç­”æ¡ˆçš„ç”Ÿæˆè´¨é‡ï¼Œæ€ä¹ˆæé«˜å‘é‡åº“äº¤äº’çš„å¬å›è´¨é‡æœ‰æˆäº†æ–°çš„é—®é¢˜ã€‚ä¹‹å‰æˆ‘ä»¬è¯´è¿‡å‘é‡åº“çš„æŸ¥è¯¢å¬å›æ˜¯é€šè¿‡å‘é‡çš„æ¯”è¾ƒå®ç°çš„ï¼Œä¸æé—®è¶Šç›¸è¿‘çš„å‘é‡è¢«å¬å›çš„æ¦‚ç‡è¶Šé«˜ã€‚ç°åœ¨æˆ‘ä»¬åªè¦æé«˜æ–‡æ¡£çš„å‘é‡è´¨é‡ï¼Œè¿™æ ·æ‰èƒ½æé«˜æŸ¥è¯¢å¬å›çš„å‡†ç¡®æ€§å’Œè´¨é‡ã€‚</p>
<h4 id="MRI"><a href="#MRI" class="headerlink" title="MRI"></a>MRI</h4><p>â€‹	MRI(Multi-representation Indexing)å¤šè¡¨ç¤ºå¼ºåŒ–ç´¢å¼•ï¼Œ<strong>ä¸ºæ¯ä¸ªæ–‡æ¡£æ„å»ºå¤šä¸ªä¸åŒè§†è§’çš„å‘é‡è¡¨ç¤º</strong>ã€‚å…¶å®è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œæˆ‘ä»¬ä¸€å¥è¯ä»ä¸åŒçš„è§’åº¦å»ç†è§£åŒ…å«äº†ä¸åŒçš„ä¿¡æ¯ï¼Œæ¯”å¦‚â€œæˆ‘ä»Šå¤©ä¸‹åˆåœ¨å†™åšå®¢â€è¿™å¥è¯ï¼Œç¬¬ä¸€ä¸ªè§’åº¦ç†è§£ï¼Œå°±æ˜¯å­—é¢æ„æ€ï¼Œæˆ‘ä»Šå¤©ä¸‹åˆå†™åšå®¢ï¼Œæ¢ä¸€ä¸ªè§’åº¦ï¼Œæˆ‘ä»Šå¤©ä¸‹åˆè¿˜æ´»ç€ï¼Œä¸ç„¶ä¹Ÿä¸èƒ½å†™åšå®¢ã€‚ä»ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬ä»ä¸¤ä¸ªè§’åº¦è·å¾—äº†ä¸¤ä¸ªä¿¡æ¯ï¼Œæ¨å¹¿ä¸€ä¸‹ï¼Œä¸€æ®µè¯ã€ä¸€ç¯‡æ–‡ç« ä¹Ÿä¸€æ ·ï¼Œä¸åŒçš„è§’åº¦çš„ç†è§£èƒ½å¾—åˆ°ä¸åŒçš„ä¿¡æ¯ï¼Œä¹Ÿå°±èƒ½æ ¹æ®è¿™äº›ä¸åŒçš„ä¿¡æ¯ç”Ÿæˆä¸åŒçš„å‘é‡ã€‚</p>
<p>â€‹	ä¸åŒç»´åº¦çš„ç†è§£æ›´åŠ ä¸°å¯Œäº†æ–‡ç« çš„å®šä¹‰ï¼Œä¸åŒç»´åº¦çš„ç†è§£ä¹Ÿå‚¬ç”Ÿäº†å¤šå‘é‡å¤šæ–‡ç« çš„æè¿°ï¼Œä»è€Œä½¿æ–‡ç« çš„å‘é‡å®šä¹‰æ›´åŠ å‡†ç¡®ï¼Œä¹Ÿä½¿æˆ‘ä»¬æŸ¥è¯¢å¬å›çš„æ—¶å€™æ›´åŠ å‡†ç¡®ã€‚</p>
<p><img src="/../images/RAG-Index/mri.png" alt="image-20250621160518166"></p>
<p>â€‹	åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¤šä»¥çˆ¶å­æ–‡æ¡£çš„æ–¹å¼å»å¤„ç†MRIï¼Œçˆ¶æ–‡æ¡£æ˜¯åŸå§‹æ–‡æ¡£ï¼Œå­æ–‡æ¡£éƒ½æ˜¯å¯¹çˆ¶æ–‡æ¡£çš„æ‘˜è¦ã€æ ‡é¢˜ç­‰å¤šç»´åº¦ç†è§£è¡¨è¾¾ï¼Œæˆ‘ä»¬é€šè¿‡å°†å­æ–‡æ¡£å­˜å…¥å‘é‡åº“ï¼Œé€šè¿‡æé—®å‘é‡åŒ¹é…å¬å›åï¼Œé€šè¿‡è¿™äº›ç†è§£è¡¨è¾¾å†æ‰¾å›çˆ¶æ–‡æ¡£è¿”å›ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> Chroma</span><br><span class="line"><span class="keyword">from</span> langchain.storage <span class="keyword">import</span> InMemoryByteStore</span><br><span class="line"><span class="keyword">from</span> langchain.retrievers.multi_vector <span class="keyword">import</span> MultiVectorRetriever</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªåŸå§‹æ–‡æ¡£</span></span><br><span class="line">raw_docs = [</span><br><span class="line">    <span class="string">&quot;LangChain is a framework for developing applications powered by language models.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Chroma is a vector database used for similarity search over embeddings.&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºæ¯ä¸ªåŸå§‹æ–‡æ¡£ç”Ÿæˆå¤šä¸ªæ‘˜è¦ï¼ˆæ‰‹åŠ¨æ¨¡æ‹Ÿï¼Œä¹Ÿå¯ä»¥ç”¨ LLM è‡ªåŠ¨ç”Ÿæˆï¼‰</span></span><br><span class="line">summaries = [</span><br><span class="line">    [<span class="string">&quot;LangChain is a framework for LLM apps.&quot;</span>, <span class="string">&quot;It helps chain language model calls.&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;Chroma is a vector store.&quot;</span>, <span class="string">&quot;It supports similarity search for embeddings.&quot;</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»™æ¯ä¸ªåŸå§‹æ–‡æ¡£ç”Ÿæˆå”¯ä¸€ ID</span></span><br><span class="line">doc_ids = [<span class="built_in">str</span>(uuid.uuid4()) <span class="keyword">for</span> _ <span class="keyword">in</span> raw_docs]</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡†å¤‡å­æ–‡æ¡£ï¼ˆç”¨äºåµŒå…¥ã€å‘é‡æ£€ç´¢ï¼‰</span></span><br><span class="line">summary_docs = []</span><br><span class="line"><span class="keyword">for</span> i, summary_list <span class="keyword">in</span> <span class="built_in">enumerate</span>(summaries):</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> summary_list:</span><br><span class="line">        summary_docs.append(Document(page_content=s, metadata=&#123;<span class="string">&quot;doc_id&quot;</span>: doc_ids[i]&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘é‡æ•°æ®åº“ç”¨äºå­˜å‚¨å­æ–‡æ¡£ï¼ˆsummaryï¼‰</span></span><br><span class="line">embedding_function = OpenAIEmbeddings()</span><br><span class="line">vectorstore = Chroma(collection_name=<span class="string">&quot;multi_index_demo&quot;</span>, embedding_function=embedding_function)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨äºå­˜å‚¨çˆ¶æ–‡æ¡£ï¼ˆåŸæ–‡ï¼‰</span></span><br><span class="line">byte_store = InMemoryByteStore()</span><br><span class="line">id_key = <span class="string">&quot;doc_id&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºå¤šå‘é‡æ£€ç´¢å™¨</span></span><br><span class="line">retriever = MultiVectorRetriever(</span><br><span class="line">    vectorstore=vectorstore,</span><br><span class="line">    byte_store=byte_store,</span><br><span class="line">    id_key=id_key,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ å­æ–‡æ¡£åˆ°å‘é‡åº“</span></span><br><span class="line">retriever.vectorstore.add_documents(summary_docs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ åŸæ–‡ï¼ˆçˆ¶æ–‡æ¡£ï¼‰åˆ°å­—èŠ‚å­˜å‚¨ä¸­</span></span><br><span class="line">retriever.docstore.mset(<span class="built_in">list</span>(<span class="built_in">zip</span>(doc_ids, raw_docs)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ğŸ” æµ‹è¯•æŸ¥è¯¢</span></span><br><span class="line">query = <span class="string">&quot;What is a vector database?&quot;</span></span><br><span class="line">results = retriever.get_relevant_documents(query, n_results=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ğŸ” ç”¨æˆ·æŸ¥è¯¢:&quot;</span>, query)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ğŸ“„ åŒ¹é…åˆ°çš„åŸå§‹æ–‡æ¡£:&quot;</span>, results[<span class="number">0</span>].page_content)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="RAPTOR"><a href="#RAPTOR" class="headerlink" title="RAPTOR"></a>RAPTOR</h4><p>â€‹	<strong>RAPTOR</strong> æ˜¯ä¸€ç§ <strong>é«˜æ•ˆæ„å»ºå¤šè¡¨ç¤ºç´¢å¼•ï¼ˆmulti-representation indexingï¼‰çš„æ–°æ–¹æ³•</strong>ï¼Œä¸Šé¢çš„MRIç›¸å½“äºå¤šç»´åº¦å¹¿åº¦ä¸Šçš„å¤„ç†ï¼Œä¸€èˆ¬æœ‰å¹¿åº¦å¤„ç†å°±æœ‰æ·±åº¦å¤„ç†ã€‚åˆšæ‰æ˜¯ä»ç»´åº¦ä¸Šå¯¹æ–‡ç« åšçš„å¤„ç†ï¼Œç°åœ¨æˆ‘ä»¬ä»æ·±åº¦ä¸Šåšå¤„ç†ã€‚æˆ‘ä»¬å¯ä»¥å°†ä¸€ç¯‡æ–‡ç« æ‹†åˆ†æˆå¤šä¸ªæ®µè½ï¼Œç„¶åå¯¹æ¯ä¸ªæ®µè½è¿›è¡Œæç‚¼æ€»ç»“ï¼Œæ€»ç»“å‡ºä¸€ä¸ªä¸ªæ ‡é¢˜ï¼Œå†å¯¹è¿™äº›æ ‡é¢˜åšå‘¢å‘é‡å¤„ç†ï¼Œç”Ÿæˆå‡ºå‘é‡ï¼Œè¿™æ ·æˆ‘ä»¬æŸ¥è¯¢åˆ°çš„æ˜¯ä¸€ä¸ªä¸ªæ®µè½ï¼Œè¿™æ ·æˆ‘ä»¬çš„æŸ¥è¯¢ç»“æœä¼šæ›´åŠ ç²¾å‡†ã€‚</p>
<p>â€‹	<strong>RAPTOR</strong> çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>å…ˆç”¨ç»“æ„åŒ–æ–¹æ³•å°†æ–‡æ¡£æ‹†åˆ†ä¸ºå¤šä¸ªå­å—ï¼ˆchunkï¼‰ï¼Œå†ç”¨ LLM ä¸ºæ¯ä¸ªå­å—ç”Ÿæˆä¸€ä¸ªæœ‰è¯­ä¹‰çš„æ ‡é¢˜ä½œä¸ºå‘é‡ç´¢å¼•çš„è¡¨ç¤º</strong>ã€‚</p>
<p><img src="/../images/RAG-Index/raptor.png" alt="image-20250621160518166"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¼ªä»£ç ï¼šchunk â†’ title â†’ embedding</span></span><br><span class="line"><span class="keyword">from</span> langchain_core.documents <span class="keyword">import</span> Document</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI, OpenAIEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-4&quot;</span>)</span><br><span class="line">embed = OpenAIEmbeddings()</span><br><span class="line"></span><br><span class="line">chunks = [...]  <span class="comment"># åŸå§‹æ–‡æ¡£åˆ†å—</span></span><br><span class="line">title_chunks = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> chunk <span class="keyword">in</span> chunks:</span><br><span class="line">    title = llm.invoke(<span class="string">f&quot;ä¸ºä»¥ä¸‹å†…å®¹ç”Ÿæˆä¸€ä¸ªä¸»é¢˜æ ‡é¢˜:\n\n<span class="subst">&#123;chunk&#125;</span>&quot;</span>)</span><br><span class="line">    title_chunks.append(Document(page_content=title, metadata=&#123;<span class="string">&quot;chunk&quot;</span>: chunk&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠŠæ ‡é¢˜ä½œä¸ºè¡¨ç¤ºåŠ å…¥å‘é‡åº“</span></span><br><span class="line">vectorstore = FAISS.from_documents(title_chunks, embed)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€ç´¢æ—¶å‘½ä¸­æ ‡é¢˜ â†’ è¿”å›åŸ chunkï¼ˆä» metadata ä¸­è·å–ï¼‰</span></span><br></pre></td></tr></table></figure>



<h4 id="ColBERT"><a href="#ColBERT" class="headerlink" title="ColBERT"></a>ColBERT</h4><p>â€‹	<strong>ColBERT</strong>ï¼ˆ<strong>Column-wise BERT</strong>ï¼‰<strong>æ”¹è¿›è¯­ä¹‰æ£€ç´¢è´¨é‡çš„æ·±åº¦è¡¨ç¤ºæ–¹æ³•</strong>ï¼Œä½†å®ƒçš„æ€è·¯å’Œå®ç°éå¸¸ç‹¬ç‰¹ï¼Œ<strong>ColBERT</strong> æ˜¯ä¸€ç§ <strong>ç»†ç²’åº¦ï¼ˆtoken-levelï¼‰è¯­ä¹‰æ£€ç´¢æ–¹æ³•</strong>ï¼Œå®ƒæŠŠæ–‡æ¡£å’ŒæŸ¥è¯¢éƒ½è¡¨ç¤ºæˆ <strong>å¤šä¸ª token å‘é‡</strong>ï¼Œç„¶åé€šè¿‡ <strong>æœ€å¤§ç›¸ä¼¼åº¦åŒ¹é…æœºåˆ¶</strong> æ¥è®¡ç®—æŸ¥è¯¢ä¸æ–‡æ¡£çš„ç›¸å…³æ€§ï¼Œä»è€Œæå‡ç²¾åº¦å’Œæ•ˆç‡ã€‚å’Œä¸Šé¢çš„REAPTOR ç±»ä¼¼å•ä¸åŒï¼ŒREAPTORæ˜¯æ‹†åˆ†å­å—ï¼Œç„¶åç”Ÿæˆæ ‡é¢˜ï¼Œè¿™ä¸ªColBERTç›´æ¥å°±æ‹†åˆ†æˆtokenäº†ï¼Œå¯ä»¥ç†è§£ä¸ºæ‹†åˆ†çš„æ›´ç»†æ›´ç¢ï¼Œä¸”æ²¡æœ‰æç‚¼ç”Ÿæˆæ ‡é¢˜çš„é˜¶æ®µã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ragatouille <span class="keyword">import</span> RAGPretrainedModel</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ ColBERT æ¨¡å‹</span></span><br><span class="line">RAG = RAGPretrainedModel.from_pretrained(<span class="string">&quot;colbert-ir/colbertv2.0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨ Wikipedia API è·å–æ–‡ç« å†…å®¹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_wikipedia_page</span>(<span class="params">title: <span class="built_in">str</span></span>):</span><br><span class="line">    URL = <span class="string">&quot;https://en.wikipedia.org/w/api.php&quot;</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: <span class="string">&quot;query&quot;</span>,</span><br><span class="line">        <span class="string">&quot;format&quot;</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;titles&quot;</span>: title,</span><br><span class="line">        <span class="string">&quot;prop&quot;</span>: <span class="string">&quot;extracts&quot;</span>,</span><br><span class="line">        <span class="string">&quot;explaintext&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    headers = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ColBERT-example/0.0.1 (your_email@example.com)&quot;</span>&#125;</span><br><span class="line">    response = requests.get(URL, params=params, headers=headers)</span><br><span class="line">    data = response.json()</span><br><span class="line">    page = <span class="built_in">next</span>(<span class="built_in">iter</span>(data[<span class="string">&quot;query&quot;</span>][<span class="string">&quot;pages&quot;</span>].values()))</span><br><span class="line">    <span class="keyword">return</span> page[<span class="string">&quot;extract&quot;</span>] <span class="keyword">if</span> <span class="string">&quot;extract&quot;</span> <span class="keyword">in</span> page <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æ–‡ç« å†…å®¹</span></span><br><span class="line">doc_text = get_wikipedia_page(<span class="string">&quot;Hayao Miyazaki&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨ ColBERT æ„å»ºå‘é‡ç´¢å¼•</span></span><br><span class="line">RAG.index(</span><br><span class="line">    collection=[doc_text],</span><br><span class="line">    index_name=<span class="string">&quot;miyazaki-demo-index&quot;</span>,</span><br><span class="line">    max_document_length=<span class="number">180</span>,</span><br><span class="line">    split_documents=<span class="literal">True</span>  <span class="comment"># ä¼šå°†é•¿æ–‡åˆ†å‰²æˆ chunks</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢ç¤ºä¾‹</span></span><br><span class="line">query = <span class="string">&quot;Which animation studio did Miyazaki found?&quot;</span></span><br><span class="line">results = RAG.search(query=query, k=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°ç»“æœ</span></span><br><span class="line"><span class="keyword">for</span> rank, hit <span class="keyword">in</span> <span class="built_in">enumerate</span>(results, <span class="number">1</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Rank <span class="subst">&#123;rank&#125;</span>:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Score:&quot;</span>, hit[<span class="string">&#x27;score&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Passage:\n&quot;</span>, hit[<span class="string">&#x27;content&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span> * <span class="number">80</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="ä¸‰è€…å¼‚åŒ"><a href="#ä¸‰è€…å¼‚åŒ" class="headerlink" title="ä¸‰è€…å¼‚åŒ"></a>ä¸‰è€…å¼‚åŒ</h4><p>â€‹	æˆ‘ä»¬æ¥è¯¦ç»†å¯¹æ¯” <strong>MRIï¼ˆMulti-representation Indexingï¼‰</strong>ã€<strong>RAPTOR</strong> å’Œ <strong>ColBERT</strong> ä¸‰è€…çš„<strong>å¼‚åŒç‚¹</strong>ã€‚</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>MRI</th>
<th>RAPTOR</th>
<th>ColBERT</th>
</tr>
</thead>
<tbody><tr>
<td>ğŸ“Œ æ ¸å¿ƒæ€è·¯</td>
<td>ä¸º<strong>åŒä¸€æ®µæ–‡æœ¬ç”Ÿæˆå¤šä¸ªä¸åŒè§†è§’çš„è¡¨ç¤ºå‘é‡</strong>ï¼ˆå¦‚ä¸»é¢˜ã€æ„å›¾ã€å…³é”®è¯ç­‰ï¼‰</td>
<td>å°†æ–‡æ¡£åˆ’åˆ†ä¸ºè¯­ä¹‰æ®µï¼ˆå°ç²’åº¦ï¼‰ï¼Œä¸ºæ¯æ®µç”Ÿæˆç®€æ´<strong>æ ‡é¢˜ï¼ˆçˆ¶æ–‡æ¡£ï¼‰</strong>ä½œä¸ºå¬å›é”šç‚¹</td>
<td>å°†æ–‡æœ¬<strong>æ‹†æˆ token ç²’åº¦</strong>ï¼Œç”¨æˆ· query ä¹Ÿæ‹†æˆ tokenï¼Œç„¶åè¿›è¡Œ token çº§åˆ«çš„<strong>Late Interaction</strong> åŒ¹é…</td>
</tr>
<tr>
<td>ğŸ¯ ä¼˜åŠ¿</td>
<td><strong>å¤šè§’åº¦è¯­ä¹‰å¢å¼ºå¬å›</strong>ï¼Œèƒ½æ•æ‰ä¸åŒç”¨æˆ·æé—®æ–¹å¼</td>
<td>ç»“æ„åŒ–æ–‡æ¡£ã€<strong>å‹ç¼©æ£€ç´¢ç©ºé—´</strong>ï¼Œæé«˜ç²¾ç¡®å¬å›ç‡</td>
<td>æ›´ç»†ç²’åº¦çš„åŒ¹é…ï¼Œ<strong>å¯è§£é‡Šæ€§å¼º</strong>ï¼Œé€‚åˆé•¿æ–‡é«˜å¯†åº¦ä¿¡æ¯æ£€ç´¢</td>
</tr>
<tr>
<td>ğŸ§© ç²’åº¦</td>
<td>Chunk&#x2F;Paragraph çº§</td>
<td>Paragraph + Title</td>
<td>Token çº§åˆ«</td>
</tr>
<tr>
<td>ğŸ§  è¡¨ç¤ºæ–¹å¼</td>
<td>å¤šå‘é‡ï¼ˆmulti-headï¼‰</td>
<td>çˆ¶å­æ–‡æ¡£ï¼ˆtitle-childï¼‰</td>
<td>Token-level è¡¨ç¤º</td>
</tr>
<tr>
<td>ğŸ“¦ æ¨¡å‹ç±»å‹</td>
<td>é€šå¸¸æ˜¯ dense encoderï¼ˆå¯å¤šæ¬¡ encodeï¼‰</td>
<td>æ ‡é¢˜ç”Ÿæˆæ¨¡å‹ + Dense encoder</td>
<td>ç‰¹æ®Šç»“æ„æ¨¡å‹ï¼ˆæ”¯æŒ Late Interactionï¼‰ï¼Œå¦‚ ColBERT æ¨¡å‹</td>
</tr>
<tr>
<td>ğŸ§ª æ£€ç´¢æ–¹å¼</td>
<td>å‘é‡ ANN</td>
<td>çˆ¶æ–‡å¬å› + å­æ–‡ rerank</td>
<td>Token-Level MaxSim èšåˆ</td>
</tr>
<tr>
<td>ğŸ§° ä»£è¡¨å®ç°</td>
<td><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2305.06983">HyDE-MRI</a>ã€[NeMo RAG]</td>
<td><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2305.06983">RAPTOR (HofstÃ¤tter et al. 2023)</a></td>
<td><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2004.12832">ColBERT</a>, <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2203.07835">ColBERTv2</a></td>
</tr>
</tbody></table>
<p>â€‹	æ¯ä¸€ç§æ–¹æ³•éƒ½æœ‰ä¼˜åŠ£ï¼Œè¿™æ—¶å€™ä½ åº”è¯¥èƒ½å¾ˆæ•æ„Ÿçš„getåˆ°ï¼Œå¦‚æœèƒ½å°†ä¸‰ç§æ–¹æ³•ç»¼åˆåœ¨ä¸€èµ·åº”è¯¥æ˜¯ä¸ªå¾ˆæ£’çš„æ–¹æ¡ˆï¼Œé‚£è¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦å­˜åœ¨å‘¢ï¼Œè‚¯å®šæ˜¯å­˜åœ¨çš„ã€‚å¦‚ä¸‹æµç¨‹æ•´åˆï¼š</p>
<ol>
<li><strong>æ–‡æ¡£åˆ†å‰²ï¼ˆRAPTORï¼‰</strong>ï¼š<ul>
<li>ç”¨ RAPTOR çš„æ–¹å¼åˆ’åˆ†è¯­ä¹‰æ®µè½ï¼Œä¸ºæ¯æ®µç”Ÿæˆæ ‡é¢˜ï¼ˆæ„å»ºçˆ¶å­ç»“æ„ï¼‰ï¼›</li>
</ul>
</li>
<li><strong>å¤šè¡¨ç¤ºç´¢å¼•ï¼ˆMRIï¼‰</strong>ï¼š<ul>
<li>å¯¹æ¯æ®µç”Ÿæˆå¤šç§è§†è§’çš„è¡¨ç¤ºå‘é‡ï¼ˆä¸»é¢˜å‘é‡ + å…³é”®è¯å‘é‡ + è¯­ä¹‰å‘é‡ï¼‰ï¼›</li>
</ul>
</li>
<li><strong>Token-level æ£€ç´¢ï¼ˆColBERTï¼‰</strong>ï¼š<ul>
<li>ç”¨æˆ· Query ä½¿ç”¨ ColBERT æ‹†æˆ token ç²’åº¦åŒ¹é…ä»¥ rerank æœ€ç»ˆç»“æœã€‚</li>
</ul>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ragatouille <span class="keyword">import</span> RAGPretrainedModel</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> pipeline</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ ColBERT æ¨¡å‹ï¼ˆç”¨äº Token-level æ£€ç´¢ï¼‰</span></span><br><span class="line">RAG = RAGPretrainedModel.from_pretrained(<span class="string">&quot;colbert-ir/colbertv2.0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨æ ‡é¢˜ç”Ÿæˆæ¨¡å‹ï¼ˆæ¨¡æ‹Ÿ RAPTOR çš„â€œçˆ¶æ–‡æ¡£â€ï¼‰</span></span><br><span class="line">title_generator = pipeline(<span class="string">&quot;text2text-generation&quot;</span>, model=<span class="string">&quot;google/flan-t5-base&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å– Wikipedia é¡µé¢</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_wikipedia_page</span>(<span class="params">title: <span class="built_in">str</span></span>):</span><br><span class="line">    URL = <span class="string">&quot;https://en.wikipedia.org/w/api.php&quot;</span></span><br><span class="line">    params = &#123;<span class="string">&quot;action&quot;</span>: <span class="string">&quot;query&quot;</span>, <span class="string">&quot;format&quot;</span>: <span class="string">&quot;json&quot;</span>, <span class="string">&quot;titles&quot;</span>: title, <span class="string">&quot;prop&quot;</span>: <span class="string">&quot;extracts&quot;</span>, <span class="string">&quot;explaintext&quot;</span>: <span class="literal">True</span>&#125;</span><br><span class="line">    headers = &#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;ColBERT-MRI-RAPTOR/0.0.1 (you@domain.com)&quot;</span>&#125;</span><br><span class="line">    resp = requests.get(URL, params=params, headers=headers)</span><br><span class="line">    page = <span class="built_in">next</span>(<span class="built_in">iter</span>(resp.json()[<span class="string">&quot;query&quot;</span>][<span class="string">&quot;pages&quot;</span>].values()))</span><br><span class="line">    <span class="keyword">return</span> page.get(<span class="string">&quot;extract&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡æ¡£æ‹†åˆ†æˆæ®µè½å¹¶ç”Ÿæˆæ ‡é¢˜ï¼ˆRAPTORæ€è·¯ï¼‰</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_and_title</span>(<span class="params">document</span>):</span><br><span class="line">    chunks = [chunk <span class="keyword">for</span> chunk <span class="keyword">in</span> document.split(<span class="string">&quot;\n\n&quot;</span>) <span class="keyword">if</span> <span class="built_in">len</span>(chunk.strip()) &gt; <span class="number">100</span>]</span><br><span class="line">    titled_chunks = []</span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> chunks:</span><br><span class="line">        title = title_generator(<span class="string">f&quot;Generate title: <span class="subst">&#123;chunk[:<span class="number">200</span>]&#125;</span>&quot;</span>, max_new_tokens=<span class="number">12</span>)[<span class="number">0</span>][<span class="string">&quot;generated_text&quot;</span>]</span><br><span class="line">        titled_chunks.append(&#123;<span class="string">&quot;title&quot;</span>: title, <span class="string">&quot;content&quot;</span>: chunk&#125;)</span><br><span class="line">    <span class="keyword">return</span> titled_chunks</span><br><span class="line"></span><br><span class="line"><span class="comment"># MRIï¼šå¤šè¡¨ç¤ºï¼ˆç¤ºä¾‹ï¼šåŸæ–‡ + å…³é”®è¯æŠ½å– + é—®é¢˜æ”¹å†™ï¼‰</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">multi_view_representations</span>(<span class="params">titled_chunks</span>):</span><br><span class="line">    views = []</span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> titled_chunks:</span><br><span class="line">        views.append(chunk[<span class="string">&quot;content&quot;</span>])  <span class="comment"># åŸå§‹ chunk</span></span><br><span class="line">        views.append(chunk[<span class="string">&quot;title&quot;</span>])    <span class="comment"># RAPTOR çš„æ ‡é¢˜</span></span><br><span class="line">        <span class="comment"># å…³é”®è¯è¡¨ç¤ºï¼ˆæ¨¡æ‹Ÿ MRIï¼‰</span></span><br><span class="line">        views.append(<span class="string">&quot;Keywords: &quot;</span> + <span class="string">&quot;, &quot;</span>.join(chunk[<span class="string">&quot;content&quot;</span>].split()[:<span class="number">10</span>]))</span><br><span class="line">    <span class="keyword">return</span> views</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºç´¢å¼•</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index_document</span>(<span class="params">title</span>):</span><br><span class="line">    full_text = get_wikipedia_page(title)</span><br><span class="line">    titled_chunks = split_and_title(full_text)</span><br><span class="line">    mri_texts = multi_view_representations(titled_chunks)</span><br><span class="line">    RAG.index(collection=mri_texts, index_name=<span class="string">f&quot;RAG-MRI-RAPTOR-<span class="subst">&#123;title&#125;</span>&quot;</span>, max_document_length=<span class="number">180</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">query, k=<span class="number">3</span></span>):</span><br><span class="line">    results = RAG.search(query=query, k=k)</span><br><span class="line">    <span class="keyword">for</span> i, hit <span class="keyword">in</span> <span class="built_in">enumerate</span>(results, <span class="number">1</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Rank <span class="subst">&#123;i&#125;</span>: [Score: <span class="subst">&#123;hit[<span class="string">&#x27;score&#x27;</span>]:<span class="number">.2</span>f&#125;</span>]&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(hit[<span class="string">&#x27;content&#x27;</span>])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">80</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹è¿è¡Œ</span></span><br><span class="line">index_document(<span class="string">&quot;Hayao Miyazaki&quot;</span>)</span><br><span class="line">search(<span class="string">&quot;Which animation studio did Hayao Miyazaki found?&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/05/RAG-%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaozhigang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaozhigang">
      <meta itemprop="description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | xiaozhigang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/05/RAG-%E8%B7%AF%E7%94%B1%E9%80%89%E6%8B%A9/" class="post-title-link" itemprop="url">RAG-è·¯ç”±é€‰æ‹©</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-05 15:28:52" itemprop="dateCreated datePublished" datetime="2025-07-05T15:28:52+08:00">2025-07-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RAG/" itemprop="url" rel="index"><span itemprop="name">RAG</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h3><p>â€‹	RAGçš„ä¸»æµç¨‹å…¶å®æ¯”è¾ƒç®€å•ï¼Œæµç¨‹å‰é¢å·²ç»è¯´è¿‡äº†ï¼Œç®€å•çœ‹ä¸€ä¸‹ä¸‹é¢çš„å›¾äº†è§£ä¸€ä¸‹å°±è¡Œã€‚</p>
<p><img src="/../images/rag-ext/rag_base_uml.png" alt="image-20250621160518166"></p>
<p>â€‹	ä»ä¸Šé¢çš„å›¾ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒRAGåœ¨å›ç­”ç”¨æˆ·é—®é¢˜çš„æ—¶å€™ï¼Œæœ€å°‘åšäº†ä¸¤æ¬¡äº¤äº’ï¼š1ã€ä¸å‘é‡æ•°æ®åº“çš„äº¤äº’ï¼Œ2ã€ä¸å¤§æ¨¡å‹çš„äº¤äº’ã€‚å¦‚æœæˆ‘ä»¬å¯¹å‘é‡æ•°æ®åº“å’Œå¤§æ¨¡å‹æœ‰äº†ç»†åˆ†ï¼Œæ¯”å¦‚ç‰©ç†ç›¸å…³æ–‡æ¡£éƒ½æ”¾åœ¨ç‰©ç†å‘é‡æ•°æ®åº“ï¼Œç‰©ç†å¤§æ¨¡å‹ä¹Ÿæ˜¯å…¨éƒ¨éƒ½ç”¨ç‰©ç†æ•°æ®è®­ç»ƒçš„ï¼Œå¦‚æœç”¨æˆ·æé—®çš„æ˜¯ç‰©ç†é—®é¢˜ï¼Œé‚£ä¸ç‰©ç†å‘é‡æ•°æ®åº“å’Œç‰©ç†å¤§æ¨¡å‹äº¤äº’æ˜¯ä¸æ˜¯èƒ½å¾—åˆ°æ›´å¥½çš„ç­”æ¡ˆï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œæ¯•ç«Ÿæ²¡æœ‰å…¶ä»–æ•°æ®çš„æ±¡æŸ“ï¼Œä¼šæŸ¥è¯¢ç”Ÿäº§çš„æ›´å¿«æ›´å‡†ã€‚</p>
<h3 id="è·¯ç”±é€‰æ‹©"><a href="#è·¯ç”±é€‰æ‹©" class="headerlink" title="è·¯ç”±é€‰æ‹©"></a>è·¯ç”±é€‰æ‹©</h3><p>â€‹	ä»ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†ä¸¤ä¸ªåœ°æ–¹å¯ä»¥åšè·¯ç”±é€‰æ‹©ï¼šå‘é‡æ•°æ®åº“ã€å¤§æ¨¡å‹ã€‚å…¶å®é™¤äº†è¿™ä¸¤ä¸ªåœ°æ–¹ï¼Œè¿˜æœ‰ä¸€ä¸ªéšå½¢çš„åœ°æ–¹ï¼Œé‚£å°±æ˜¯æç¤ºè¯æ¨¡ç‰ˆã€‚æˆ‘ä»¬è°ƒç”¨å¤§æ¨¡å‹çš„æ—¶å€™æ˜¯è¦è¾“å…¥æç¤ºè¯çš„ï¼Œæç¤ºè¯éƒ½æ˜¯æŒ‰æ¨¡ç‰ˆè¾“å…¥çš„ï¼Œå¦‚æœæˆ‘ä»¬ç»†åˆ†åšå¥½åˆ†ç±»ï¼ŒæŒ‰ä¸åŒçš„é—®é¢˜é€‰æ‹©ç‰¹å®šçš„æ¨¡ç‰ˆï¼Œä¹Ÿèƒ½æé«˜æˆ‘ä»¬ç”Ÿæˆæ›´å¥½ç­”æ¡ˆçš„æ¦‚ç‡ã€‚</p>
<p>â€‹	è¯´ç›´ç™½ä¸€ç‚¹ï¼Œå°±æ˜¯æ ¹æ®é—®é¢˜çš„ç±»å‹ï¼Œé€‰æ‹©ç›¸åº”çš„å‘é‡åº“ã€æ¨¡ç‰ˆå’Œå¤§æ¨¡å‹ã€‚</p>
<h4 id="å‘é‡æ•°æ®åº“è·¯ç”±"><a href="#å‘é‡æ•°æ®åº“è·¯ç”±" class="headerlink" title="å‘é‡æ•°æ®åº“è·¯ç”±"></a>å‘é‡æ•°æ®åº“è·¯ç”±</h4><p>â€‹	å…¶å®æˆ‘ä»¬æ˜¯æ²¡æœ‰åŠæ³•ç›´æ¥åŒºåˆ†ç”¨æˆ·é—®é¢˜çš„ç±»å‹çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥è®©å¤§æ¨¡å‹å»åšåŒºåˆ†ã€‚æ‹¿åˆ°åŒºåˆ†åçš„ç»“æœï¼Œå»é€‰æ‹©ç›¸åº”çš„è·¯ç”±ã€‚</p>
<pre class="mermaid">graph LR
A(å¼€å§‹) --> B[åˆ’å®šåˆ†ç±»èŒƒå›´]
B --> C[å¤§æ¨¡å‹åˆ¤æ–­åˆ†ç±»]
C --> D[é€‰æ‹©å‘é‡åº“]
D --> E(ç»“æŸ)</pre>

<p>â€‹	1ã€åˆ’å®šåˆ†ç±»ï¼šæ ¹æ®æˆ‘ä»¬å·²æœ‰çš„å‘é‡æ•°æ®åº“è®¾ç½®å¥½åˆ†ç±»ï¼Œè§„èŒƒå¥½åˆ†ç±»ç§ç±»ã€‚</p>
<p>â€‹	2ã€å¤§æ¨¡å‹åˆ¤æ–­ï¼šè¾“å…¥ç”¨æˆ·é—®é¢˜ï¼Œå’Œæˆ‘ä»¬è®¾ç½®å¥½çš„åˆ†ç±»ï¼Œè®©å¤§æ¨¡å‹åˆ¤æ–­å‡ºç”¨æˆ·è¾“å…¥é—®é¢˜æ˜¯åˆ†ç±»ä¸­çš„å“ªä¸€ç±»ï¼Œæˆ–è€…è¯´ä¸åˆ†ç±»ä¸­å“ªä¸€ç±»ç›¸å…³æ€§æœ€é«˜ã€‚</p>
<p>â€‹	3ã€é€‰æ‹©å‘é‡åº“ï¼šæ ¹æ®å¤§æ¨¡å‹çš„åˆ¤æ–­ç»“æœï¼Œé€‰æ‹©å·²æœ‰çš„å‘é‡åº“ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Literal</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_core.pydantic_v1 <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line"><span class="comment"># Data model</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RouteQuery</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Route a user query to the most relevant datasource.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    datasource: <span class="type">Literal</span>[<span class="string">&quot;python_docs&quot;</span>, <span class="string">&quot;js_docs&quot;</span>, <span class="string">&quot;golang_docs&quot;</span>] = Field(</span><br><span class="line">        ...,</span><br><span class="line">        description=<span class="string">&quot;Given a user question choose which datasource would be most relevant for answering their question&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># LLM with function call </span></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-3.5-turbo-0125&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">structured_llm = llm.with_structured_output(RouteQuery)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prompt </span></span><br><span class="line">system = <span class="string">&quot;&quot;&quot;You are an expert at routing a user question to the appropriate data source.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Based on the programming language the question is referring to, route it to the relevant data source.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">prompt = ChatPromptTemplate.from_messages(</span><br><span class="line">    [</span><br><span class="line">        (<span class="string">&quot;system&quot;</span>, system),</span><br><span class="line">        (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;question&#125;&quot;</span>),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define router </span></span><br><span class="line">router = prompt | structured_llm</span><br></pre></td></tr></table></figure>



<h4 id="æç¤ºè¯æ¨¡ç‰ˆè·¯ç”±"><a href="#æç¤ºè¯æ¨¡ç‰ˆè·¯ç”±" class="headerlink" title="æç¤ºè¯æ¨¡ç‰ˆè·¯ç”±"></a>æç¤ºè¯æ¨¡ç‰ˆè·¯ç”±</h4><p>â€‹	å¥—è·¯æ˜¾ç„¶å’Œä¸Šé¢çš„å‘é‡åº“çš„å¥—è·¯ä¸€æ ·ï¼Œç”¨å¤§æ¨¡å‹è·å–åˆ°åˆ†ç±»ï¼Œåœ¨ç”¨åˆ†ç±»å»è·å–é¢„è®¾å¥½çš„æç¤ºè¯æ¨¡ç‰ˆã€‚ä»£ç ç±»åŒï¼Œèƒ½æ‹¿åˆ°å¯¹åº”çš„åˆ†ç±»ï¼Œæ‰¾åˆ°åˆ†ç±»å¯¹åº”çš„æ¨¡ç‰ˆå³å¯ã€‚</p>
<pre class="mermaid">graph LR
A(å¼€å§‹) --> B[åˆ’å®šåˆ†ç±»èŒƒå›´]
B --> C[å¤§æ¨¡å‹åˆ¤æ–­åˆ†ç±»]
C --> D[é€‰æ‹©æç¤ºè¯æ¨¡ç‰ˆ]
D --> E(ç»“æŸ)</pre>



<h4 id="å¤§æ¨¡å‹è·¯ç”±"><a href="#å¤§æ¨¡å‹è·¯ç”±" class="headerlink" title="å¤§æ¨¡å‹è·¯ç”±"></a>å¤§æ¨¡å‹è·¯ç”±</h4><p>â€‹	å¥—è·¯ä¸€æ ·ï¼Œç”¨å¤§æ¨¡å‹çš„åˆ¤æ–­ç»“æœå»é€‰æ‹©ç›¸åº”çš„å¤§æ¨¡å‹ã€‚ä»£ç ç±»åŒã€‚</p>
<pre class="mermaid">graph LR
A(å¼€å§‹) --> B[åˆ’å®šåˆ†ç±»èŒƒå›´]
B --> C[å¤§æ¨¡å‹åˆ¤æ–­åˆ†ç±»]
C --> D[é€‰æ‹©å¤§æ¨¡å‹]
D --> E(ç»“æŸ)</pre>



<h4 id="å…¶ä»–è·¯ç”±é€‰æ‹©æ–¹æ³•"><a href="#å…¶ä»–è·¯ç”±é€‰æ‹©æ–¹æ³•" class="headerlink" title="å…¶ä»–è·¯ç”±é€‰æ‹©æ–¹æ³•"></a>å…¶ä»–è·¯ç”±é€‰æ‹©æ–¹æ³•</h4><p>â€‹	é™¤äº†ä¸Šè¿°ä½¿ç”¨å¤§æ¨¡å‹åˆ¤æ–­åˆ†ç±»ï¼Œè¿˜æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•åˆ¤æ–­åˆ†ç±»ï¼Œè‚¯å®šæ˜¯æœ‰çš„ã€‚ä»¥å‘é‡è®¡ç®—ç›¸å…³æ€§ï¼Œåˆ¤æ–­å‡ºæœ€ç›¸å…³çš„åˆ†ç±»ã€‚ä½¿ç”¨embeddingsè®¡ç®—å‡ºé¢„è®¾æ¨¡ç‰ˆçš„å‘é‡ï¼Œå†è®¡ç®—å‡ºç”¨æˆ·é—®é¢˜çš„å‘é‡ï¼Œæœ€åæ‰¾å‡ºä¸é—®é¢˜å‘é‡æœ€ç›¸å…³çš„é¢„è®¾æ¨¡ç‰ˆã€‚èƒ½æ‰¾å‡ºæ¨¡ç‰ˆä¹Ÿå°±çŸ¥é“é¢„è®¾æ¨¡ç‰ˆçš„åˆ†ç±»ï¼Œä½¿ç”¨åˆ†ç±»å»æ‰¾å‘é‡åº“å’Œå¤§æ¨¡å‹å³å¯ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.utils.math <span class="keyword">import</span> cosine_similarity</span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnableLambda, RunnablePassthrough</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI, OpenAIEmbeddings</span><br><span class="line"></span><br><span class="line"><span class="comment"># Two prompts</span></span><br><span class="line">physics_template = <span class="string">&quot;&quot;&quot;You are a very smart physics professor. \</span></span><br><span class="line"><span class="string">You are great at answering questions about physics in a concise and easy to understand manner. \</span></span><br><span class="line"><span class="string">When you don&#x27;t know the answer to a question you admit that you don&#x27;t know.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Here is a question:</span></span><br><span class="line"><span class="string">&#123;query&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">math_template = <span class="string">&quot;&quot;&quot;You are a very good mathematician. You are great at answering math questions. \</span></span><br><span class="line"><span class="string">You are so good because you are able to break down hard problems into their component parts, \</span></span><br><span class="line"><span class="string">answer the component parts, and then put them together to answer the broader question.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Here is a question:</span></span><br><span class="line"><span class="string">&#123;query&#125;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Embed prompts</span></span><br><span class="line">embeddings = OpenAIEmbeddings()</span><br><span class="line">prompt_templates = [physics_template, math_template]</span><br><span class="line">prompt_embeddings = embeddings.embed_documents(prompt_templates)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Route question to prompt </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prompt_router</span>(<span class="params"><span class="built_in">input</span></span>):</span><br><span class="line">    <span class="comment"># Embed question</span></span><br><span class="line">    query_embedding = embeddings.embed_query(<span class="built_in">input</span>[<span class="string">&quot;query&quot;</span>])</span><br><span class="line">    <span class="comment"># Compute similarity</span></span><br><span class="line">    similarity = cosine_similarity([query_embedding], prompt_embeddings)[<span class="number">0</span>]</span><br><span class="line">    most_similar = prompt_templates[similarity.argmax()]</span><br><span class="line">    <span class="comment"># Chosen prompt </span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Using MATH&quot;</span> <span class="keyword">if</span> most_similar == math_template <span class="keyword">else</span> <span class="string">&quot;Using PHYSICS&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> PromptTemplate.from_template(most_similar)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chain = (</span><br><span class="line">    &#123;<span class="string">&quot;query&quot;</span>: RunnablePassthrough()&#125;</span><br><span class="line">    | RunnableLambda(prompt_router)</span><br><span class="line">    | ChatOpenAI()</span><br><span class="line">    | StrOutputParser()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(chain.invoke(<span class="string">&quot;What&#x27;s a black hole&quot;</span>))</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/01/spring%E4%B8%AD%E7%9A%84%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E4%B8%8B%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaozhigang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaozhigang">
      <meta itemprop="description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | xiaozhigang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/07/01/spring%E4%B8%AD%E7%9A%84%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B8%8E%E4%B8%8B%E8%BD%BD/" class="post-title-link" itemprop="url">Springçš„å¤§æ–‡ä»¶ä¸Šä¼ ä¸ä¸‹è½½</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-07-01 20:35:49" itemprop="dateCreated datePublished" datetime="2025-07-01T20:35:49+08:00">2025-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-05-01 20:35:49" itemprop="dateModified" datetime="2025-05-01T20:35:49+08:00">2025-05-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JAVA/" itemprop="url" rel="index"><span itemprop="name">JAVA</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h3><p>â€‹	è¿™å‘¨é‡åˆ°ä¸¤ä¸ªæ–°é—®é¢˜ï¼Œå°±æ˜¯å¤§æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ã€‚</p>
<table>
<thead>
<tr>
<th align="center">åœºæ™¯</th>
<th align="center">ä¹‹å‰</th>
<th align="center">é—®é¢˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">å¤§æ–‡ä»¶ä¸Šä¼ äº‘å­˜å‚¨</td>
<td align="center">æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œåœ¨ä»æœåŠ¡å™¨ä¸Šä¼ åˆ°äº‘å­˜å‚¨</td>
<td align="center">1ã€é€šè¿‡nginxã€nacosè½¬å‘è€—æ—¶å¤ªé•¿&nbsp;<br/>2ã€å¤ªæ¶ˆè€—æœåŠ¡å™¨èµ„æº</td>
</tr>
<tr>
<td align="center">ç”¨æˆ·ä¸‹è½½è§†é¢‘</td>
<td align="center">ä»å…¶ä»–ç«¯ä¸‹è½½è§†é¢‘ï¼Œå†å°†è§†é¢‘è½¬å‘ç»™å®¢æˆ·ç«¯</td>
<td align="center">åŒä¸Š</td>
</tr>
</tbody></table>
<p>â€‹	è¿™ä¸¤ä¸ªé—®é¢˜çš„è§£å†³ï¼Œè¿˜å¾—æ„Ÿè°¢chatgptï¼Œè¿™ç©æ„è¿˜æ˜¯å¥½ç”¨çš„ã€‚</p>
<h3 id="å¤§æ–‡ä»¶ä¸Šä¼ "><a href="#å¤§æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="å¤§æ–‡ä»¶ä¸Šä¼ "></a>å¤§æ–‡ä»¶ä¸Šä¼ </h3><p>â€‹	ä¹‹å‰éƒ½æ˜¯ç›´æ¥å°†æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œé€šè¿‡æœåŠ¡å™¨å°†æ–‡ä»¶ä¸Šä¼ åˆ°äº‘ç«¯ï¼Œæ‹¿åˆ°é“¾æ¥åä¿å­˜é“¾æ¥ã€‚è¿™æ ·åˆšå¼€å§‹ä½¿ç”¨çš„æ—¶å€™è¿˜è¡Œï¼Œä¸Šä¼ çš„æ–‡ä»¶æ¯”è¾ƒå°ï¼Œåæ¥è¦ä¸Šä¼ å¤§æ–‡ä»¶ï¼Œé—®é¢˜å°±æš´éœ²å‡ºæ¥äº†ï¼Œè€—æ—¶å¤ªé•¿ã€‚æ–‡ä»¶è¦ç»è¿‡nginxã€nacosçš„è½¬å‘ï¼Œä¸€ä¸ª200Mçš„æ–‡ä»¶ï¼Œåˆ°æœåŠ¡å™¨åç«¯ä»£ç å¼€å§‹å¤„ç†å·²ç»è¿‡å»åå¤šåˆ†é’Ÿäº†ã€‚é™¤äº†è€—æ—¶ï¼Œè¿˜å¤ªæ¶ˆè€—èµ„æºï¼Œnginxã€nacosã€springæœåŠ¡è¿™æ¯ä¸€é¡¹éƒ½è¦è½¬å‘ä¸€ä¸‹å¤§æ–‡ä»¶ï¼Œéƒ½è¦æ¶ˆè€—å†…å­˜æµé‡ã€‚</p>
<p>â€‹	è§£å†³æ–¹æ¡ˆï¼š1ã€æ”¹é•¿ç›¸åº”æ—¶é—´ï¼Œ2ã€ä¿®æ”¹è®¾è®¡æ–¹æ¡ˆã€‚ç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜æ˜¾ä¸è¡Œï¼Œæ²¡è§£å†³æ ¹æœ¬é—®é¢˜ï¼Œè€—æ—¶é•¿ï¼Œèµ„æºæ¶ˆè€—å¤§çš„é—®é¢˜è¿˜æ˜¯å­˜åœ¨ã€‚é‚£å°±åªèƒ½è€ƒè™‘ç¬¬äºŒä¸ªè§£å†³æ–¹æ¡ˆäº†ã€‚</p>
<p>â€‹	å…¶å®åˆšå¼€å§‹ï¼Œæˆ‘ä¹Ÿæ²¡å•¥å¥½çš„è§£å†³æ–¹æ¡ˆï¼ˆè§è¯†çŸ­æµ…ï¼‰ã€‚åæ¥é—®äº†ä¸€ä¸‹chatgptï¼Œè§£å†³æ–¹æ¡ˆç›´æ¥å°±å‡ºæ¥äº†ï¼Œç”Ÿæˆé¢„é“¾æ¥ï¼Œè®©å‰ç«¯é€šè¿‡é¢„é“¾æ¥ä¸Šä¼ æ–‡ä»¶ã€‚è¯´æ˜¯ä¸šç•Œéƒ½ç”¨çš„è¿™ç§æ–¹æ¡ˆï¼Œæˆ‘ä»¬éƒ½ä¸çŸ¥é“ï¼Œè¿˜æ˜¯è½åå‘¢è„±èŠ‚äº†å•Šã€‚æˆ‘ä»¬å…¬å¸ç”¨çš„æ˜¯AWSçš„S3å­˜å‚¨ï¼Œå®ƒæ˜¯æ”¯æŒç”Ÿæˆé¢„é“¾æ¥çš„ï¼Œé™¤äº†AWSï¼Œå…¶ä»–çš„äº‘å‚å•†éƒ½æ˜¯æ”¯æŒçš„ï¼ˆé˜¿é‡Œäº‘ï¼Œè…¾è®¯äº‘ç­‰ï¼‰ã€‚ä¸ºäº†ä¿éšœé“¾æ¥çš„æœ‰æ•ˆæ€§ï¼Œæˆ‘åœ¨ååŠ äº†ä¸€ä¸ªåœ°å€æ ¡éªŒï¼Œæ ¡éªŒä¸€ä¸‹é¢„é“¾æ¥çš„åœ°å€å‰ç«¯æœ‰æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶ï¼Œé˜²æ­¢å‰ç«¯æ²¡æœ‰ä¸Šä¼ ã€‚ä»£ç ç¼–å†™éšä¾¿ç™¾åº¦ä¸€ä¸‹å¤§æŠŠã€‚</p>
<p><img src="/Users/xiaozhigang/blog/source/images/java-big-file/image-20250705170312520.png" alt="image-20250705170312520"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”Ÿæˆä¸€ä¸ªå¯ç”¨äº PUT ä¸Šä¼ çš„é¢„ç­¾å URL</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bucketName   S3æ¡¶å</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> objectKey    ä¸Šä¼ åˆ° S3 çš„ keyï¼ˆè·¯å¾„+æ–‡ä»¶åï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> contentType  ä¸Šä¼ å†…å®¹ç±»å‹ï¼ˆå¦‚ &quot;image/jpeg&quot;, &quot;application/pdf&quot;ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> validMinutes URL æœ‰æ•ˆæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> å¯ç”¨çš„ PUT è¯·æ±‚ URL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> URL <span class="title function_">generatePresignedPutUrl</span><span class="params">(String bucketName, String objectKey, String contentType, <span class="type">int</span> validMinutes)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– S3 PreSignerï¼ˆçº¿ç¨‹å®‰å…¨ï¼Œå¯å¤ç”¨ï¼‰</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">S3Presigner</span> <span class="variable">preSigner</span> <span class="operator">=</span> S3Presigner.builder()</span><br><span class="line">            .region(REGION)</span><br><span class="line">            .credentialsProvider(StaticCredentialsProvider.create(</span><br><span class="line">                    AwsBasicCredentials.create(ACCESS_KEY, SECRET_KEY)</span><br><span class="line">            ))</span><br><span class="line">            .build()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">PutObjectRequest</span> <span class="variable">putObjectRequest</span> <span class="operator">=</span> PutObjectRequest.builder()</span><br><span class="line">                .bucket(bucketName)</span><br><span class="line">                .key(objectKey)</span><br><span class="line">                .acl(ObjectCannedACL.PUBLIC_READ)</span><br><span class="line">                .contentType(contentType)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">PresignedPutObjectRequest</span> <span class="variable">preSignedRequest</span> <span class="operator">=</span> preSigner.presignPutObject(builder -&gt; builder</span><br><span class="line">                .putObjectRequest(putObjectRequest)</span><br><span class="line">                .signatureDuration(Duration.ofMinutes(validMinutes)) <span class="comment">// æœ‰æ•ˆæœŸ</span></span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// å¯ç”¨äºå‰ç«¯ PUT ä¸Šä¼ </span></span><br><span class="line">        <span class="keyword">return</span> preSignedRequest.url();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="è§†é¢‘ä¸‹è½½"><a href="#è§†é¢‘ä¸‹è½½" class="headerlink" title="è§†é¢‘ä¸‹è½½"></a>è§†é¢‘ä¸‹è½½</h3><p>â€‹	èƒŒæ™¯ï¼šæœ¬æ¥å¯ä»¥æä¾›ä¸‰æ–¹çš„è§†é¢‘é“¾æ¥ç›´æ¥ç»™å‰ç«¯ä¸‹è½½çš„ï¼Œå¯ä»¥è§†é¢‘é“¾æ¥æœ‰åæ‰’æ ¡éªŒï¼Œé¢„ipç»‘å®šï¼Œå…¶ä»–ipéƒ½æ‰“ä¸å¼€é“¾æ¥ï¼Œæ‰€ä»¥åªèƒ½åç«¯æœåŠ¡å™¨ä¸‹è½½äº†ä¼ ç»™å‰ç«¯ã€‚</p>
<p>â€‹	åˆæ¬¡è§£å†³æ–¹æ¡ˆï¼šæœåŠ¡å™¨ç›´æ¥ä¸‹è½½å®Œï¼Œå†è½¬å‘ç»™å‰ç«¯ä¸‹è½½ï¼Œä½†æ˜¯è¿™æ ·è¦ä¸å‰ç«¯ä¿æŒé“¾æ¥çš„æ—¶é—´å¤ªé•¿äº†ï¼ŒæœåŠ¡ç«¯è¦ä¸‹è½½ä¸€éï¼Œå‰ç«¯ä¹Ÿè¦æ¥ç€ä¸‹è½½ä¸€éã€‚åŒæ—¶ä¹Ÿæ¶ˆè€—æœåŠ¡å™¨èµ„æºï¼Œå¸¦å®½æµé‡å’ŒæœåŠ¡å™¨å†…å­˜ã€‚</p>
<p>â€‹	ä¼˜åŒ–æ–¹æ¡ˆï¼šé€šè¿‡æœåŠ¡å™¨ç›´æ¥é€ä¼ ç»™å‰ç«¯ï¼Œè¿™æ ·æœåŠ¡å™¨ä¸ç”¨ä¿å­˜ï¼Œå¯ä»¥å‡å°‘å†…å­˜çš„å‹åŠ›ï¼ŒåŒæ—¶ä¹Ÿå‡å°‘ç›¸åº”çš„æ—¶é—´ã€‚ä¸è¿‡è¿™ä¹Ÿæœ‰é—®é¢˜ï¼Œå‰ç«¯æ²¡é‚£ä¹ˆç¨³å®šï¼Œä¼šæ–­ï¼Œå¯¼è‡´æ•´ä¸ªè§†é¢‘ä¸‹è½½ä¸äº†ã€‚</p>
<p>â€‹	æœ€ç»ˆæ–¹æ¡ˆï¼šåˆ†ç‰‡è¿”å›ç»™å‰ç«¯ï¼Œå°†ä¸€ä¸ªè§†é¢‘æµåˆ‡æˆå¾ˆå¤šç‰‡ï¼Œæ¯æ¬¡è¯·æ±‚ä¸€ç‰‡ï¼Œè¿™æ ·å°†ä¸€ä¸ªé•¿è¿æ¥å˜æˆäº†è®¸å¤šçŸ­è¿æ¥ã€‚ä¸ä¼šå› å‰ç«¯çš„ä¸€æ¬¡æ–­å¼€ï¼Œå¯¼è‡´æ•´ä¸ªä¸‹è½½å¤±è´¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/pronhub/url/download&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;StreamingResponseBody&gt; <span class="title function_">downloadVideoWithRange</span><span class="params">(</span></span><br><span class="line"><span class="params">        HttpServletRequest request,</span></span><br><span class="line"><span class="params">        HttpServletResponse response,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestBody</span> PronhubUrlDownLoadRequest body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">videoUrl</span> <span class="operator">=</span> body.getUrl();</span><br><span class="line">    <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(videoUrl);</span><br><span class="line">    <span class="type">HttpURLConnection</span> <span class="variable">conn</span> <span class="operator">=</span> (HttpURLConnection) url.openConnection();</span><br><span class="line">    conn.setRequestProperty(<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Mozilla/5.0&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">responseCode</span> <span class="operator">=</span> conn.getResponseCode();</span><br><span class="line">    <span class="keyword">if</span> (responseCode != <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(responseCode)</span><br><span class="line">                .contentType(MediaType.TEXT_PLAIN)</span><br><span class="line">                .body(out -&gt; out.write((<span class="string">&quot;è§†é¢‘è¯·æ±‚å¤±è´¥: &quot;</span> + responseCode).getBytes(StandardCharsets.UTF_8)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> conn.getContentType();</span><br><span class="line">    <span class="type">int</span> <span class="variable">fullLength</span> <span class="operator">=</span> conn.getContentLength();</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">rangeHeader</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Range&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rangeHeader != <span class="literal">null</span> &amp;&amp; rangeHeader.startsWith(<span class="string">&quot;bytes=&quot;</span>)) &#123;</span><br><span class="line">        String[] ranges = rangeHeader.replace(<span class="string">&quot;bytes=&quot;</span>, <span class="string">&quot;&quot;</span>).split(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">        start = Integer.parseInt(ranges[<span class="number">0</span>].trim());</span><br><span class="line">        <span class="keyword">if</span> (ranges.length &gt; <span class="number">1</span> &amp;&amp; !ranges[<span class="number">1</span>].isEmpty()) &#123;</span><br><span class="line">            end = Integer.parseInt(ranges[<span class="number">1</span>].trim());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœå®¢æˆ·ç«¯åªç»™äº† startï¼Œæ²¡æœ‰ endï¼Œä¸»åŠ¨é™åˆ¶æœ€å¤š CHUNK_SIZE</span></span><br><span class="line">            end = Math.min(start + CHUNK_SIZE - <span class="number">1</span>, fullLength - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰ Range è¯·æ±‚æ—¶ï¼Œé»˜è®¤è¿”å›ä»å¤´å¼€å§‹çš„ä¸€ä¸ª 5MB åˆ†ç‰‡</span></span><br><span class="line">        end = Math.min(start + CHUNK_SIZE - <span class="number">1</span>, fullLength - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">rangeLength</span> <span class="operator">=</span> end - start + <span class="number">1</span>;</span><br><span class="line">    conn.setRequestProperty(<span class="string">&quot;Range&quot;</span>, <span class="string">&quot;bytes=&quot;</span> + start + <span class="string">&quot;-&quot;</span> + end);</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> conn.getInputStream();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">finalStart</span> <span class="operator">=</span> start;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">finalEnd</span> <span class="operator">=</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="type">StreamingResponseBody</span> <span class="variable">stream</span> <span class="operator">=</span> outputStream -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> inputStream) &#123;</span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line">            <span class="type">int</span> bytesRead;</span><br><span class="line">            <span class="type">long</span> <span class="variable">totalRead</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">lastFlush</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((bytesRead = in.read(buffer)) != -<span class="number">1</span> &amp;&amp; totalRead &lt; rangeLength) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">toWrite</span> <span class="operator">=</span> (<span class="type">int</span>) Math.min(bytesRead, rangeLength - totalRead);</span><br><span class="line">                outputStream.write(buffer, <span class="number">0</span>, toWrite);</span><br><span class="line">                totalRead += toWrite;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (System.currentTimeMillis() - lastFlush &gt; <span class="number">2000</span>) &#123;</span><br><span class="line">                    outputStream.flush();</span><br><span class="line">                    lastFlush = System.currentTimeMillis();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            outputStream.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ex.getMessage().contains(<span class="string">&quot;Broken pipe&quot;</span>)) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;å®¢æˆ·ç«¯è¿æ¥ä¸­æ–­: &#123;&#125;&quot;</span>, ex.getMessage());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;è§†é¢‘ä¼ è¾“å¼‚å¸¸: &quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.status(HttpStatus.PARTIAL_CONTENT)</span><br><span class="line">            .header(<span class="string">&quot;Accept-Ranges&quot;</span>, <span class="string">&quot;bytes&quot;</span>)</span><br><span class="line">            .header(<span class="string">&quot;Content-Type&quot;</span>, contentType != <span class="literal">null</span> ? contentType : <span class="string">&quot;video/mp4&quot;</span>)</span><br><span class="line">            .header(<span class="string">&quot;Content-Length&quot;</span>, String.valueOf(rangeLength))</span><br><span class="line">            .header(<span class="string">&quot;Content-Range&quot;</span>, String.format(<span class="string">&quot;bytes %d-%d/%d&quot;</span>, finalStart, finalEnd, fullLength))</span><br><span class="line">            .header(<span class="string">&quot;Full-Length&quot;</span>, String.valueOf(fullLength))</span><br><span class="line">            .header(<span class="string">&quot;Access-Control-Expose-Headers&quot;</span>, <span class="string">&quot;Content-Range,Full-Length&quot;</span>)</span><br><span class="line">            .header(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">&quot;attachment; filename=video.mp4&quot;</span>)</span><br><span class="line">            .body(stream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/06/21/RAG-%E4%B8%B0%E5%AF%8C%E6%8F%90%E7%A4%BA%E8%AF%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaozhigang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaozhigang">
      <meta itemprop="description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | xiaozhigang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/06/21/RAG-%E4%B8%B0%E5%AF%8C%E6%8F%90%E7%A4%BA%E8%AF%8D/" class="post-title-link" itemprop="url">RAG-ä¸°å¯Œæç¤ºè¯</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-06-21 15:28:52" itemprop="dateCreated datePublished" datetime="2025-06-21T15:28:52+08:00">2025-06-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/RAG/" itemprop="url" rel="index"><span itemprop="name">RAG</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h3><p>â€‹	RAGçš„ä¸»æµç¨‹å…¶å®æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å…ˆå°†ç”¨æˆ·çš„æé—®å»å‘é‡æ•°æ®åº“æŸ¥è¯¢ç›¸å…³æ–‡æ¡£ï¼Œå†å°†æ–‡æ¡£å’Œç”¨æˆ·æé—®ç»„è£…å‘é€ç»™å¤§æ¨¡å‹ç”Ÿæˆç­”æ¡ˆï¼Œæœ€åå°†ç­”æ¡ˆè¿”å›ç»™ç”¨æˆ·ã€‚å…¶ä¸­ä¸»è¦çš„ç»„ä»¶åªæœ‰å‘é‡æ•°æ®åº“å’Œå¤§æ¨¡å‹ï¼Œåªæ˜¯ä¸¤ç›¸ç»„åˆå¯ä»¥ç©å‡ºèŠ±æ¥ã€‚</p>
<p><img src="/../images/rag-ext/rag_base_uml.png" alt="image-20250621160518166"></p>
<h3 id="ä¸°å¯Œæç¤ºè¯"><a href="#ä¸°å¯Œæç¤ºè¯" class="headerlink" title="ä¸°å¯Œæç¤ºè¯"></a>ä¸°å¯Œæç¤ºè¯</h3><p>â€‹	RAGæ„æ€æ˜¯æ£€ç´¢å¢å¼ºç”Ÿæˆï¼Œå¤§æ¨¡å‹çš„ç”Ÿæˆéƒ½æ˜¯æ ¹æ®æç¤ºè¯ç”Ÿæˆçš„ï¼Œè€Œå‘é‡åº“çš„å­˜åœ¨å°±æ˜¯ä¸ºäº†ä¸°å¯Œæˆ‘ä»¬çš„æç¤ºè¯ï¼Œä¸°å¯Œäº†æˆ‘ä»¬çš„æç¤ºè¯ï¼Œå¤§æ¨¡å‹æ‰èƒ½ç”Ÿæˆå‡ºæ›´ç†æƒ³æ›´ä¸°å¯Œåˆé€‚çš„ç­”æ¡ˆã€‚é‚£æ€ä¹ˆä¸°å¯Œæˆ‘ä»¬çš„æç¤ºè¯å‘¢ï¼Ÿ</p>
<h4 id="å¤šç‰ˆæœ¬æŸ¥è¯¢"><a href="#å¤šç‰ˆæœ¬æŸ¥è¯¢" class="headerlink" title="å¤šç‰ˆæœ¬æŸ¥è¯¢"></a>å¤šç‰ˆæœ¬æŸ¥è¯¢</h4><p>â€‹	åœ¨æˆ‘ä»¬ç”¨é—®é¢˜å‘é‡åŒ–ä¹‹åå‘é‡å»æ£€ç´¢å‘é‡åº“å¾—åˆ°æ–‡æ¡£çš„æ—¶å€™ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½å°½å¯èƒ½å¤šçš„è·å–ç›¸å…³æ€§çš„æ–‡æ¡£ï¼Œæ¯”å¦‚è¯´ï¼Œæˆ‘çš„æé—®æ˜¯ç”¨æ±‰è¯­æé—®é¢˜çš„ï¼Œè¿™æ—¶å€™å‘é‡åŒ–ä¹‹åä¸€å®šä¼šå¸¦æœ‰æ±‰è¯­çš„å‘é‡ï¼Œå¯¼è‡´æ£€ç´¢å‘é‡åº“çš„æ—¶å€™æ£€ç´¢åˆ°å¯èƒ½éƒ½æ˜¯æ±‰è¯­çš„æ–‡æ¡£ï¼Œå…¶å®æœ‰äº›é—®é¢˜çš„è‹±è¯­æ–‡æ¡£æˆ–è€…å…¶ä»–è¯­è¨€çš„æ–‡æ¡£æ›´å…¨é¢ï¼Œå¦‚æœæ£€ç´¢åˆ°è¿™äº›æ–‡æ¡£ï¼Œå»ä¸°å¯Œæˆ‘ä»¬çš„æç¤ºè¯ï¼Œç”Ÿæˆçš„ç­”æ¡ˆå°±ä¼šæ›´å¥½ã€‚</p>
<p>â€‹	å½“ç„¶æˆ‘ä»¬åœ¨æé—®çš„æ—¶å€™ä¸å¯èƒ½æ¯ä¸ªè¯­è¨€æˆ–è€…å…¶ä»–è§’åº¦éƒ½æè¿°åˆ°ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥è®©llmå¸®æˆ‘ä»¬ç”Ÿæˆè¿™äº›ç‰ˆæœ¬çš„é—®é¢˜ï¼Œå»æ£€ç´¢åˆ°æ›´å¤šæ›´æœ‰æ•ˆçš„æ–‡æ¡£ã€‚</p>
<p><img src="/../images/rag-ext/multi_query_1.png" alt="image-20250621160518166"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># Multi Query: Different Perspectives</span></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;You are an AI language model assistant. Your task is to generate five </span></span><br><span class="line"><span class="string">different versions of the given user question to retrieve relevant documents from a vector </span></span><br><span class="line"><span class="string">database. By generating multiple perspectives on the user question, your goal is to help</span></span><br><span class="line"><span class="string">the user overcome some of the limitations of the distance-based similarity search. </span></span><br><span class="line"><span class="string">Provide these alternative questions separated by newlines. Original question: &#123;question&#125;&quot;&quot;&quot;</span></span><br><span class="line">prompt_perspectives = ChatPromptTemplate.from_template(template)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line">generate_queries = (</span><br><span class="line">    prompt_perspectives </span><br><span class="line">    | ChatOpenAI(temperature=<span class="number">0</span>) </span><br><span class="line">    | StrOutputParser() </span><br><span class="line">    | (<span class="keyword">lambda</span> x: x.split(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain.load <span class="keyword">import</span> dumps, loads</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_unique_union</span>(<span class="params">documents: <span class="built_in">list</span>[<span class="built_in">list</span>]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Unique union of retrieved docs &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Flatten list of lists, and convert each Document to string</span></span><br><span class="line">    flattened_docs = [dumps(doc) <span class="keyword">for</span> sublist <span class="keyword">in</span> documents <span class="keyword">for</span> doc <span class="keyword">in</span> sublist]</span><br><span class="line">    <span class="comment"># Get unique documents</span></span><br><span class="line">    unique_docs = <span class="built_in">list</span>(<span class="built_in">set</span>(flattened_docs))</span><br><span class="line">    <span class="comment"># Return</span></span><br><span class="line">    <span class="keyword">return</span> [loads(doc) <span class="keyword">for</span> doc <span class="keyword">in</span> unique_docs]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Retrieve</span></span><br><span class="line">question = <span class="string">&quot;What is task decomposition for LLM agents?&quot;</span></span><br><span class="line">retrieval_chain = generate_queries | retriever.<span class="built_in">map</span>() | get_unique_union</span><br><span class="line">docs = retrieval_chain.invoke(&#123;<span class="string">&quot;question&quot;</span>:question&#125;)</span><br><span class="line"><span class="built_in">len</span>(docs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnablePassthrough</span><br><span class="line"></span><br><span class="line"><span class="comment"># RAG</span></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;Answer the following question based on this context:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Question: &#123;question&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">prompt = ChatPromptTemplate.from_template(template)</span><br><span class="line"></span><br><span class="line">llm = ChatOpenAI(temperature=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">final_rag_chain = (</span><br><span class="line">    &#123;<span class="string">&quot;context&quot;</span>: retrieval_chain, </span><br><span class="line">     <span class="string">&quot;question&quot;</span>: itemgetter(<span class="string">&quot;question&quot;</span>)&#125; </span><br><span class="line">    | prompt</span><br><span class="line">    | llm</span><br><span class="line">    | StrOutputParser()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">final_rag_chain.invoke(&#123;<span class="string">&quot;question&quot;</span>:question&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="ç»“æœèåˆ"><a href="#ç»“æœèåˆ" class="headerlink" title="ç»“æœèåˆ"></a>ç»“æœèåˆ</h4><p>â€‹	ä¸Šé¢çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å°†å¤šç‰ˆæœ¬æ£€ç´¢å‡ºæ¥çš„ç»“æœéƒ½æäº¤ç»™å¤§æ¨¡å‹ç”Ÿæˆç­”æ¡ˆäº†ï¼Œå¤šç‰ˆæœ¬æ£€ç´¢å‡ºæ¥çš„å¤šç»“æœè‚¯å®šæœ‰å¥½æœ‰åï¼Œåçš„ç»“æœä¸€èµ·æäº¤ç»™å¤§æ¨¡å‹ï¼Œè‚¯å®šä¹Ÿä¼šå½±å“å¤§æ¨¡å‹ç”Ÿæˆç­”æ¡ˆï¼Œé‚£æˆ‘ä»¬è¦æ€ä¹ˆåšæ‰èƒ½è®©å‡å°‘åç»“æœçš„å½±å“å‘¢ï¼Ÿ</p>
<p>â€‹	åœ¨æˆ‘ä»¬æœç´¢çš„å¤šç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æ–‡æ¡£åœ¨æ¯ä¸ªåˆ—è¡¨ä¸­çš„æ’åï¼Œé€šè¿‡ RRF ç®—æ³•ä¸ºæ¯ä¸ªæ–‡æ¡£æ‰“åˆ†ï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ª<strong>èåˆåçš„æ’åºåˆ—è¡¨</strong>ï¼Œæœ€åä»åˆ—è¡¨ä¸­ç­›é€‰å‡ºå‰å‡ ä¸ªæˆ‘ä»¬æƒ³è¦çš„ç»“æœå³å¯ã€‚</p>
<p>ç»™å®šå¤šä¸ªæ–‡æ¡£æ’ååˆ—è¡¨ï¼ˆå¤šä¸ªæ£€ç´¢å™¨ã€å¤šä¸ªæŸ¥è¯¢ï¼‰ï¼ŒRRF çš„æ‰“åˆ†å…¬å¼å¦‚ä¸‹ï¼š</p>
<p>$$<br>\text{Score}(d) &#x3D; \sum_{i&#x3D;1}^{n} \frac{1}{\text{rank}_i + k}<br>$$</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>( \text{rank}_i )ï¼šæ–‡æ¡£ ( d ) åœ¨ç¬¬ ( i ) ä¸ªæ’åºåˆ—è¡¨ä¸­çš„æ’åï¼ˆä» 0 å¼€å§‹ï¼‰</li>
<li>( k )ï¼šå¹³æ»‘å‚æ•°ï¼ˆé€šå¸¸å– 60ï¼‰</li>
<li>( n )ï¼šæ€»å…±èåˆçš„åˆ—è¡¨æ•°é‡ï¼ˆä¾‹å¦‚ä¸åŒæŸ¥è¯¢æˆ–ä¸åŒæ£€ç´¢å™¨ï¼‰</li>
</ul>
<blockquote>
<p>æ–‡æ¡£å‡ºç°è¶Šå¤šã€æ’åè¶Šé å‰ï¼Œå…¶ RRF å¾—åˆ†å°±è¶Šé«˜ã€‚</p>
</blockquote>
<p><img src="/../images/rag-ext/multi_query_2.png" alt="image-20250621160518166"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">reciprocal_rank_fusion</span>(<span class="params">results: <span class="built_in">list</span>[<span class="built_in">list</span>], k=<span class="number">60</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Reciprocal_rank_fusion that takes multiple lists of ranked documents </span></span><br><span class="line"><span class="string">        and an optional parameter k used in the RRF formula &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Initialize a dictionary to hold fused scores for each unique document</span></span><br><span class="line">    fused_scores = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Iterate through each list of ranked documents</span></span><br><span class="line">    <span class="keyword">for</span> docs <span class="keyword">in</span> results:</span><br><span class="line">        <span class="comment"># Iterate through each document in the list, with its rank (position in the list)</span></span><br><span class="line">        <span class="keyword">for</span> rank, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(docs):</span><br><span class="line">            <span class="comment"># Convert the document to a string format to use as a key (assumes documents can be serialized to JSON)</span></span><br><span class="line">            doc_str = dumps(doc)</span><br><span class="line">            <span class="comment"># If the document is not yet in the fused_scores dictionary, add it with an initial score of 0</span></span><br><span class="line">            <span class="keyword">if</span> doc_str <span class="keyword">not</span> <span class="keyword">in</span> fused_scores:</span><br><span class="line">                fused_scores[doc_str] = <span class="number">0</span></span><br><span class="line">            <span class="comment"># Retrieve the current score of the document, if any</span></span><br><span class="line">            previous_score = fused_scores[doc_str]</span><br><span class="line">            <span class="comment"># Update the score of the document using the RRF formula: 1 / (rank + k)</span></span><br><span class="line">            fused_scores[doc_str] += <span class="number">1</span> / (rank + k)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Sort the documents based on their fused scores in descending order to get the final reranked results</span></span><br><span class="line">    reranked_results = [</span><br><span class="line">        (loads(doc), score)</span><br><span class="line">        <span class="keyword">for</span> doc, score <span class="keyword">in</span> <span class="built_in">sorted</span>(fused_scores.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return the reranked results as a list of tuples, each containing the document and its fused score</span></span><br><span class="line">    <span class="keyword">return</span> reranked_results</span><br></pre></td></tr></table></figure>

<h4 id="æé—®åˆ†è§£"><a href="#æé—®åˆ†è§£" class="headerlink" title="æé—®åˆ†è§£"></a>æé—®åˆ†è§£</h4><p>â€‹	ä»ç‰ˆæœ¬çš„è§’åº¦è®©æˆ‘ä»¬çš„æç¤ºè¯æ›´ä¸°å¯Œäº†ï¼Œä½†æ˜¯åœ¨è¯­ä¹‰æè¿°æ–¹é¢ï¼Œèƒ½ä¸èƒ½æå‡ä¸€ä¸‹æˆ‘ä»¬çš„æç¤ºè¯ã€‚åœ¨ä¸€ä¸ªå¤æ‚å›°éš¾çš„é—®é¢˜ä¸Šæˆ‘ä»¬çš„æç¤ºè¯å¯èƒ½æ˜¯ä¸å¤Ÿçš„ï¼Œæ¯•ç«Ÿé—®é¢˜çš„èŒƒå›´æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬çš„æè¿°èŒƒå›´æœ‰é™ã€‚å¦‚æœæˆ‘ä»¬ç¼©å°é—®é¢˜çš„èŒƒå›´ï¼Œå˜æˆå°é—®é¢˜ï¼Œæˆ‘ä»¬çš„æç¤ºè¯æ˜¯ä¸æ˜¯å°±æ¯”è¾ƒä¸°å¯Œäº†ã€‚åœ¨æˆ‘ä»¬ç»éªŒä¸­ï¼Œé‚£ç§å¤æ‚çš„é—®é¢˜ï¼Œæ¯”è¾ƒå¥½çš„è§£å†³åŠæ³•å°±æ˜¯æŠŠå®ƒæ‹†åˆ†æˆä¸€ä¸ªä¸€ä¸ªçš„å°é—®é¢˜ï¼Œç„¶åä¾æ¬¡å»è§£å†³è¿™äº›å°é—®é¢˜ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬åŒæ ·å¯ä»¥å¥—ç”¨è¿™ç§è§£å†³æ–¹å¼ï¼ŒæŠŠå¤æ‚é—®é¢˜ç”©ç»™å¤§æ¨¡å‹è®©ä»–å¸®æˆ‘ä»¬æ‹†åˆ†æˆä¸€ä¸ªä¸€ä¸ªçš„å°é—®é¢˜ï¼Œç„¶åæˆ‘ä»¬ä¾æ¬¡å»æé—®è§£å†³è¿™äº›å°é—®é¢˜ã€‚æ­£å¯¹æ¯ä¸€ä¸ªå°é—®é¢˜æˆ‘ä»¬çš„æç¤ºè¯æ˜¯ä¸æ˜¯å°±ä¸°å¯Œäº†</p>
<h5 id="é€’å½’å›ç­”"><a href="#é€’å½’å›ç­”" class="headerlink" title="é€’å½’å›ç­”"></a>é€’å½’å›ç­”</h5><p>â€‹	æ€ä¹ˆå»è§£å†³è¿™äº›å°é—®é¢˜ï¼Œå¦‚æœè¿™äº›å°é—®é¢˜ä¸Šä¸‹æœ‰ç›¸å…³æ€§çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€’å½’é€’å½’å›ç­”ï¼Œå°±æ˜¯å°†ä¸Šä¸€ä¸ªé—®é¢˜çš„ç­”æ¡ˆå¸¦å…¥åˆ°ä¸‹ä¸€ä¸ªé—®é¢˜ä¸­ã€‚</p>
<p><img src="/../images/rag-ext/decomposition.png" alt="image-20250621160518166"></p>
<p>â€‹	å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ªå¤æ‚é—®é¢˜æ‹†åˆ†æˆ3ä¸ªå°é—®é¢˜ï¼Œç„¶åä¾æ¬¡æŸ¥è¯¢ç”Ÿæˆè§£å†³ï¼Œå°†æ¯æ¬¡è§£å†³çš„ç»“æœå¸¦å…¥åˆ°ä¸‹ä¸€æ¬¡è§£å†³ä¸­ï¼Œæœ€åè§£å†³è¿™ä¸ªå¤æ‚é—®é¢˜ç”Ÿæˆä¸€ä¸ªå®Œæ•´ç­”æ¡ˆè¾“å‡ºã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># Decomposition</span></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;You are a helpful assistant that generates multiple sub-questions related to an input question. \n</span></span><br><span class="line"><span class="string">The goal is to break down the input into a set of sub-problems / sub-questions that can be answers in isolation. \n</span></span><br><span class="line"><span class="string">Generate multiple search queries related to: &#123;question&#125; \n</span></span><br><span class="line"><span class="string">Output (3 queries):&quot;&quot;&quot;</span></span><br><span class="line">prompt_decomposition = ChatPromptTemplate.from_template(template)</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"></span><br><span class="line"><span class="comment"># LLM</span></span><br><span class="line">llm = ChatOpenAI(temperature=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Chain</span></span><br><span class="line">generate_queries_decomposition = ( prompt_decomposition | llm | StrOutputParser() | (<span class="keyword">lambda</span> x: x.split(<span class="string">&quot;\n&quot;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run</span></span><br><span class="line">question = <span class="string">&quot;What are the main components of an LLM-powered autonomous agent system?&quot;</span></span><br><span class="line">questions = generate_queries_decomposition.invoke(&#123;<span class="string">&quot;question&quot;</span>:question&#125;)</span><br><span class="line"><span class="comment"># Prompt</span></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;Here is the question you need to answer:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">\n --- \n &#123;question&#125; \n --- \n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Here is any available background question + answer pairs:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">\n --- \n &#123;q_a_pairs&#125; \n --- \n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Here is additional context relevant to the question: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">\n --- \n &#123;context&#125; \n --- \n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Use the above context and any background question + answer pairs to answer the question: \n &#123;question&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">decomposition_prompt = ChatPromptTemplate.from_template(template)</span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_qa_pair</span>(<span class="params">question, answer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Format Q and A pair&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    formatted_string = <span class="string">&quot;&quot;</span></span><br><span class="line">    formatted_string += <span class="string">f&quot;Question: <span class="subst">&#123;question&#125;</span>\nAnswer: <span class="subst">&#123;answer&#125;</span>\n\n&quot;</span></span><br><span class="line">    <span class="keyword">return</span> formatted_string.strip()</span><br><span class="line"></span><br><span class="line"><span class="comment"># llm</span></span><br><span class="line">llm = ChatOpenAI(model_name=<span class="string">&quot;gpt-3.5-turbo&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">q_a_pairs = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> q <span class="keyword">in</span> questions:</span><br><span class="line">    </span><br><span class="line">    rag_chain = (</span><br><span class="line">    &#123;<span class="string">&quot;context&quot;</span>: itemgetter(<span class="string">&quot;question&quot;</span>) | retriever, </span><br><span class="line">     <span class="string">&quot;question&quot;</span>: itemgetter(<span class="string">&quot;question&quot;</span>),</span><br><span class="line">     <span class="string">&quot;q_a_pairs&quot;</span>: itemgetter(<span class="string">&quot;q_a_pairs&quot;</span>)&#125; </span><br><span class="line">    | decomposition_prompt</span><br><span class="line">    | llm</span><br><span class="line">    | StrOutputParser())</span><br><span class="line"></span><br><span class="line">    answer = rag_chain.invoke(&#123;<span class="string">&quot;question&quot;</span>:q,<span class="string">&quot;q_a_pairs&quot;</span>:q_a_pairs&#125;)</span><br><span class="line">    q_a_pair = format_qa_pair(q,answer)</span><br><span class="line">    q_a_pairs = q_a_pairs + <span class="string">&quot;\n---\n&quot;</span>+  q_a_pair</span><br></pre></td></tr></table></figure>

<h5 id="èåˆå›ç­”"><a href="#èåˆå›ç­”" class="headerlink" title="èåˆå›ç­”"></a>èåˆå›ç­”</h5><p>â€‹	å¦‚æœè¿™äº›å°é—®é¢˜ä¸Šä¸‹æ–‡æ²¡æœ‰ç›¸å…³æ€§æˆ–è€…è¯´æ²¡æœ‰ä¾èµ–æ€§ï¼Œæˆ‘ä»¬åˆè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå¯ä»¥å°†æ¯ä¸€ä¸ªå°é—®é¢˜å•ç‹¬çš„å»è§£å†³ç”Ÿæˆç­”æ¡ˆï¼Œæœ€åå°†æ‰€æœ‰å°é—®é¢˜çš„ç­”æ¡ˆèåˆç”Ÿæˆå¤æ‚é—®é¢˜çš„æ±‡æ€»ç­”æ¡ˆå°±è¡Œäº†ã€‚</p>
<p><img src="/../images/rag-ext/answer_individually.png" alt="image-20250621160518166"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Answer each sub-question individually </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain <span class="keyword">import</span> hub</span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain_core.runnables <span class="keyword">import</span> RunnablePassthrough, RunnableLambda</span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line"><span class="comment"># RAG prompt</span></span><br><span class="line">prompt_rag = hub.pull(<span class="string">&quot;rlm/rag-prompt&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">retrieve_and_rag</span>(<span class="params">question,prompt_rag,sub_question_generator_chain</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;RAG on each sub-question&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Use our decomposition / </span></span><br><span class="line">    sub_questions = sub_question_generator_chain.invoke(&#123;<span class="string">&quot;question&quot;</span>:question&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Initialize a list to hold RAG chain results</span></span><br><span class="line">    rag_results = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> sub_question <span class="keyword">in</span> sub_questions:</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Retrieve documents for each sub-question</span></span><br><span class="line">        retrieved_docs = retriever.get_relevant_documents(sub_question)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Use retrieved documents and sub-question in RAG chain</span></span><br><span class="line">        answer = (prompt_rag | llm | StrOutputParser()).invoke(&#123;<span class="string">&quot;context&quot;</span>: retrieved_docs, </span><br><span class="line">                                                                <span class="string">&quot;question&quot;</span>: sub_question&#125;)</span><br><span class="line">        rag_results.append(answer)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> rag_results,sub_questions</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wrap the retrieval and RAG process in a RunnableLambda for integration into a chain</span></span><br><span class="line">answers, questions = retrieve_and_rag(question, prompt_rag, generate_queries_decomposition)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_qa_pairs</span>(<span class="params">questions, answers</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Format Q and A pairs&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    formatted_string = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i, (question, answer) <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">zip</span>(questions, answers), start=<span class="number">1</span>):</span><br><span class="line">        formatted_string += <span class="string">f&quot;Question <span class="subst">&#123;i&#125;</span>: <span class="subst">&#123;question&#125;</span>\nAnswer <span class="subst">&#123;i&#125;</span>: <span class="subst">&#123;answer&#125;</span>\n\n&quot;</span></span><br><span class="line">    <span class="keyword">return</span> formatted_string.strip()</span><br><span class="line"></span><br><span class="line">context = format_qa_pairs(questions, answers)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prompt</span></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;Here is a set of Q+A pairs:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Use these to synthesize an answer to the question: &#123;question&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">prompt = ChatPromptTemplate.from_template(template)</span><br><span class="line"></span><br><span class="line">final_rag_chain = (</span><br><span class="line">    prompt</span><br><span class="line">    | llm</span><br><span class="line">    | StrOutputParser()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">final_rag_chain.invoke(&#123;<span class="string">&quot;context&quot;</span>:context,<span class="string">&quot;question&quot;</span>:question&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="åé€€é‡å¤ç”Ÿæˆ"><a href="#åé€€é‡å¤ç”Ÿæˆ" class="headerlink" title="åé€€é‡å¤ç”Ÿæˆ"></a>åé€€é‡å¤ç”Ÿæˆ</h4><p>â€‹	å¯¹äºå¤æ‚é—®é¢˜ï¼Œé™¤äº†ä¸Šé¢è¯´çš„æ‹†åˆ†æˆå­é—®é¢˜æœ‰æ²¡æœ‰å…¶ä»–çš„æ–¹å¼è®©æˆ‘ä»¬çš„æç¤ºè¯å˜å¾—æ›´ä¸°å¯Œäº†å‘¢ï¼Ÿç­”æ¡ˆè‚¯å®šæ˜¯æœ‰çš„ï¼Œå°±æ˜¯åé€€é‡å¤ç”Ÿæˆã€‚å•¥æ„æ€å‘¢ï¼Œå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡çš„æç¤ºè¯ä¸ä¸°å¯Œï¼Œé‚£æˆ‘ä»¬è®©ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„ç»“æœåŠ åˆ°æç¤ºè¯ä¸­ï¼Œè¿™æ—¶å€™æˆ‘ä»¬çš„æç¤ºè¯æ˜¯ä¸æ˜¯æ›´ä¸°å¯Œäº†ï¼Œåœ¨ç”¨è¿™ä¸ªä¸°å¯Œçš„æç¤ºè¯å†å»ç”Ÿæˆï¼Œæ˜¯ä¸æ˜¯ç»“æœæ›´å¥½äº†å‘¢ï¼Œå¦‚æœä¸å¤Ÿï¼Œæˆ‘ä»¬å†å°†ç”Ÿæˆçš„ç»“æœåŠ å…¥æç¤ºè¯å†ç”Ÿæˆä¸€æ¬¡å‘¢ï¼Œä¸€ç›´åˆ°æ»¡æ„ä¸ºæ­¢ã€‚</p>
<p><img src="/../images/rag-ext/step_back.png" alt="image-20250621160518166"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Few Shot Examples</span></span><br><span class="line"><span class="keyword">from</span> langchain_core.prompts <span class="keyword">import</span> ChatPromptTemplate, FewShotChatMessagePromptTemplate</span><br><span class="line">examples = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;input&quot;</span>: <span class="string">&quot;Could the members of The Police perform lawful arrests?&quot;</span>,</span><br><span class="line">        <span class="string">&quot;output&quot;</span>: <span class="string">&quot;what can the members of The Police do?&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;input&quot;</span>: <span class="string">&quot;Jan Sindelâ€™s was born in what country?&quot;</span>,</span><br><span class="line">        <span class="string">&quot;output&quot;</span>: <span class="string">&quot;what is Jan Sindelâ€™s personal history?&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"><span class="comment"># We now transform these to example messages</span></span><br><span class="line">example_prompt = ChatPromptTemplate.from_messages(</span><br><span class="line">    [</span><br><span class="line">        (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;ai&quot;</span>, <span class="string">&quot;&#123;output&#125;&quot;</span>),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line">few_shot_prompt = FewShotChatMessagePromptTemplate(</span><br><span class="line">    example_prompt=example_prompt,</span><br><span class="line">    examples=examples,</span><br><span class="line">)</span><br><span class="line">prompt = ChatPromptTemplate.from_messages(</span><br><span class="line">    [</span><br><span class="line">        (</span><br><span class="line">            <span class="string">&quot;system&quot;</span>,</span><br><span class="line">            <span class="string">&quot;&quot;&quot;You are an expert at world knowledge. Your task is to step back and paraphrase a question to a more generic step-back question, which is easier to answer. Here are a few examples:&quot;&quot;&quot;</span>,</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment"># Few shot examples</span></span><br><span class="line">        few_shot_prompt,</span><br><span class="line">        <span class="comment"># New question</span></span><br><span class="line">        (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;question&#125;&quot;</span>),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line">generate_queries_step_back = prompt | ChatOpenAI(temperature=<span class="number">0</span>) | StrOutputParser()</span><br><span class="line">question = <span class="string">&quot;What is task decomposition for LLM agents?&quot;</span></span><br><span class="line">generate_queries_step_back.invoke(&#123;<span class="string">&quot;question&quot;</span>: question&#125;)</span><br><span class="line"><span class="comment"># Response prompt </span></span><br><span class="line">response_prompt_template = <span class="string">&quot;&quot;&quot;You are an expert of world knowledge. I am going to ask you a question. Your response should be comprehensive and not contradicted with the following context if they are relevant. Otherwise, ignore them if they are not relevant.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># &#123;normal_context&#125;</span></span><br><span class="line"><span class="string"># &#123;step_back_context&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Original Question: &#123;question&#125;</span></span><br><span class="line"><span class="string"># Answer:&quot;&quot;&quot;</span></span><br><span class="line">response_prompt = ChatPromptTemplate.from_template(response_prompt_template)</span><br><span class="line"></span><br><span class="line">chain = (</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"># Retrieve context using the normal question</span></span><br><span class="line">        <span class="string">&quot;normal_context&quot;</span>: RunnableLambda(<span class="keyword">lambda</span> x: x[<span class="string">&quot;question&quot;</span>]) | retriever,</span><br><span class="line">        <span class="comment"># Retrieve context using the step-back question</span></span><br><span class="line">        <span class="string">&quot;step_back_context&quot;</span>: generate_queries_step_back | retriever,</span><br><span class="line">        <span class="comment"># Pass on the question</span></span><br><span class="line">        <span class="string">&quot;question&quot;</span>: <span class="keyword">lambda</span> x: x[<span class="string">&quot;question&quot;</span>],</span><br><span class="line">    &#125;</span><br><span class="line">    | response_prompt</span><br><span class="line">    | ChatOpenAI(temperature=<span class="number">0</span>)</span><br><span class="line">    | StrOutputParser()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">chain.invoke(&#123;<span class="string">&quot;question&quot;</span>: question&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="å‡æƒ³æ–‡æ¡£"><a href="#å‡æƒ³æ–‡æ¡£" class="headerlink" title="å‡æƒ³æ–‡æ¡£"></a>å‡æƒ³æ–‡æ¡£</h4><p>â€‹	å¦‚æœæˆ‘ä»¬çš„å‘é‡æ•°æ®åº“ä¸­ï¼Œæ²¡æœ‰æˆ‘ä»¬æé—®çš„æ‰€éœ€è¦çš„æ–‡æ¡£å’Œç›¸å…³çŸ¥è¯†æ€ä¹ˆåŠï¼Ÿè¿™æ—¶å€™ä»å‘é‡åº“çš„æ£€ç´¢æ˜¯æ²¡åŠæ³•å¸®æˆ‘ä»¬ä¸°å¯Œæç¤ºè¯çš„ï¼Œä½†æ˜¯æˆ‘ä»¬è®©llmå¸®æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªå‡æƒ³æ–‡æ¡£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ–‡æ¡£è·å¾—è·Ÿä¸°å¯Œçš„æç¤ºè¯ä»è€Œç”Ÿæˆå‡ºæ›´ä¸°æ»¡çš„ç­”æ¡ˆäº†ã€‚</p>
<p><img src="/../images/rag-ext/hyde.png" alt="image-20250621160518166"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line"><span class="comment"># HyDE document genration</span></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;Please write a scientific paper passage to answer the question</span></span><br><span class="line"><span class="string">Question: &#123;question&#125;</span></span><br><span class="line"><span class="string">Passage:&quot;&quot;&quot;</span></span><br><span class="line">prompt_hyde = ChatPromptTemplate.from_template(template)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> langchain_core.output_parsers <span class="keyword">import</span> StrOutputParser</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line">generate_docs_for_retrieval = (</span><br><span class="line">    prompt_hyde | ChatOpenAI(temperature=<span class="number">0</span>) | StrOutputParser() </span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run</span></span><br><span class="line">question = <span class="string">&quot;What is task decomposition for LLM agents?&quot;</span></span><br><span class="line">generate_docs_for_retrieval.invoke(&#123;<span class="string">&quot;question&quot;</span>:question&#125;)</span><br><span class="line"><span class="comment"># Retrieve</span></span><br><span class="line">retrieval_chain = generate_docs_for_retrieval | retriever </span><br><span class="line">retireved_docs = retrieval_chain.invoke(&#123;<span class="string">&quot;question&quot;</span>:question&#125;)</span><br><span class="line">retireved_docs</span><br><span class="line"><span class="comment"># RAG</span></span><br><span class="line">template = <span class="string">&quot;&quot;&quot;Answer the following question based on this context:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;context&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Question: &#123;question&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">prompt = ChatPromptTemplate.from_template(template)</span><br><span class="line"></span><br><span class="line">final_rag_chain = (</span><br><span class="line">    prompt</span><br><span class="line">    | llm</span><br><span class="line">    | StrOutputParser()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">final_rag_chain.invoke(&#123;<span class="string">&quot;context&quot;</span>:retireved_docs,<span class="string">&quot;question&quot;</span>:question&#125;)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/02/18/%E9%9D%A2%E8%AF%95%E5%A4%8D%E7%9B%98-25-02-17/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaozhigang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaozhigang">
      <meta itemprop="description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | xiaozhigang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/02/18/%E9%9D%A2%E8%AF%95%E5%A4%8D%E7%9B%98-25-02-17/" class="post-title-link" itemprop="url">é¢è¯•å¤ç›˜-25-02-17</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-02-18 18:39:52 / ä¿®æ”¹æ—¶é—´ï¼š21:09:36" itemprop="dateCreated datePublished" datetime="2025-02-18T18:39:52+08:00">2025-02-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9D%A2%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">é¢è¯•</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h2><p>25å¹´ç¬¬ä¸€æ¬¡é¢è¯•ï¼Œç”µè¯é¢è¯•ï¼Œè¿™æ¬¡é¢è¯•æ²¡æœ‰å‡†å¤‡å¥½ï¼Œè¿˜æ²¡æ¥å¾—åŠå¤ä¹ ã€‚</p>
<h2 id="è‡ªæˆ‘ä»‹ç»"><a href="#è‡ªæˆ‘ä»‹ç»" class="headerlink" title="è‡ªæˆ‘ä»‹ç»"></a>è‡ªæˆ‘ä»‹ç»</h2><p>19å¹´æ¯•ä¸šï¼Œ5å¹´å¤šå·¥ä½œç»éªŒï¼Œç›®å‰æ­£åœ¨ä¼˜ç¾äº’åŠ¨è¿™è¾¹å·¥ä½œã€‚</p>
<p>å®šä½ï¼šé«˜å¼€ï¼Œä¹‹å‰å¸¦é¢†ä¸‰å››ä¸ªäººï¼Œç›®å‰å› ä¸ºå›¢é˜Ÿè§„æ¨¡ï¼Œå„è‡ªä¸€æ‘Šã€‚</p>
<p>ç›®å‰å›¢é˜Ÿä¸šåŠ¡æ˜¯åšä¸€äº›å°åº”ç”¨æŠ•æ”¾æµ·å¤–å¸‚åœºï¼Œèµšå–ä¸€äº›æ”¶ç›Šã€‚è¿›å…¥å›¢é˜Ÿå¿«ä¸€å¹´çš„æ—¶é—´ï¼Œå‚ä¸äº†æ–‡ç”Ÿå›¾å’ŒäººåæŸ¥è¯¢ç­‰é¡¹ç›®ã€‚</p>
<p>ä¹‹å‰åä¸ºå›¢é˜Ÿä¹Ÿå·¥ä½œäº†ä¸‰å¹´å·¦å³çš„æ—¶é—´ï¼Œä¸šåŠ¡æ˜¯ä»¥æ´å¯Ÿã€è¯„ä¼°ã€è§„åˆ’å’Œæ”¶ç›Šå››ä¸ªéƒ¨åˆ†å‘è¿è¥å•†æä¾›æ•°å­—åŒ–æœºä¼šç‚¹å‘ç°ã€‚è‡ªå·±ä¹Ÿå‚ä¸äº†å…¨çƒæ•°æ®æ²™ç›˜é¡¹ç›®ï¼Œåˆ°è·¯ç½‘ç®—æ³•å¼€å§‹å‚ä¸é¡¹ç›®ï¼Œç„¶åå¼€å§‹OTN to æ¥¼å®‡å‚ä¸ä¸šåŠ¡æ‹“å±•ï¼Œåˆ°æœ€åçš„æ¨¡å‹æ”¶ç¼–å’ŒåŸå­èƒ½åŠ›ç¼–æ’é‡æ„é¡¹ç›®ã€‚</p>
<p>ä¸šåŠ¡çˆ±å¥½ï¼šæ‰“ç¯®çƒï¼Œè·‘æ­¥ï¼Œçœ‹çœ‹ä¹¦ï¼Œæœ‰æ—¶é—´ä¹Ÿä¼šå†™å†™åšå®¢ã€‚</p>
<h3 id="é¡¹ç›®ç»éªŒ"><a href="#é¡¹ç›®ç»éªŒ" class="headerlink" title="é¡¹ç›®ç»éªŒ"></a>é¡¹ç›®ç»éªŒ</h3><h4 id="çŸ¥è¯†åº“"><a href="#çŸ¥è¯†åº“" class="headerlink" title="çŸ¥è¯†åº“"></a>çŸ¥è¯†åº“</h4><h4 id="æ–‡ç”Ÿå›¾"><a href="#æ–‡ç”Ÿå›¾" class="headerlink" title="æ–‡ç”Ÿå›¾"></a>æ–‡ç”Ÿå›¾</h4><h4 id="åŸå­èƒ½åŠ›"><a href="#åŸå­èƒ½åŠ›" class="headerlink" title="åŸå­èƒ½åŠ›"></a>åŸå­èƒ½åŠ›</h4><h3 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h3><h4 id="ä»€ä¹ˆæƒ…å†µä¸‹redisçš„æŸ¥è¯¢ä¼šå¾ˆæ…¢"><a href="#ä»€ä¹ˆæƒ…å†µä¸‹redisçš„æŸ¥è¯¢ä¼šå¾ˆæ…¢" class="headerlink" title="ä»€ä¹ˆæƒ…å†µä¸‹redisçš„æŸ¥è¯¢ä¼šå¾ˆæ…¢"></a>ä»€ä¹ˆæƒ…å†µä¸‹redisçš„æŸ¥è¯¢ä¼šå¾ˆæ…¢</h4><p>ä¸¤ç§æƒ…å†µï¼Œä¼ è¾“çš„æ—¶å€™å¾ˆæ…¢ï¼Œrediså¤„ç†çš„æ—¶å€™å¾ˆæ…¢</p>
<p>1ã€ä¼ è¾“çš„æ—¶å€™å¾ˆæ…¢ï¼šç½‘é€Ÿä¸å¥½ï¼Œç½‘ç»œæœåŠ¡å™¨éƒ¨ç½²å¤ªè¿œã€‚</p>
<p>2ã€rediså¤„ç†å¾ˆæ…¢ï¼š</p>
<p>â€‹	1ã€å­˜åœ¨bigkeyï¼Œhotkeyï¼Œå ç”¨äº†å¸¦å®½å’Œå¤„ç†é€Ÿåº¦</p>
<p>â€‹	2ã€å­˜åœ¨å¤æ‚æŸ¥è¯¢ï¼Œå¤æ‚åº¦åœ¨O(n)</p>
<p>â€‹	</p>
<h4 id="redisä¸­çš„å¤§keyæ€ä¹ˆåˆ é™¤"><a href="#redisä¸­çš„å¤§keyæ€ä¹ˆåˆ é™¤" class="headerlink" title="redisä¸­çš„å¤§keyæ€ä¹ˆåˆ é™¤"></a>redisä¸­çš„å¤§keyæ€ä¹ˆåˆ é™¤</h4><p>1ã€<strong>åˆ†éš”</strong>ï¼šå°†ä¸€ä¸ªbigkeyåˆ†éš”æˆå¤šä¸ªå°keyï¼Œä¾‹å¦‚å°†ä¸€ä¸ªå«æœ‰ä¸Šä¸‡å­—æ®µçš„hashæŒ‰ç…§ä¸€å®šçš„ç­–ç•¥æ‹†åˆ†æˆå¤šä¸ªhash</p>
<p>2ã€<strong>æ‰‹åŠ¨æ¸…ç†</strong>ï¼šredis4.0+å¯ä»¥ä½¿ç”¨ UNLINK å‘½ä»¤æ¥å¼‚æ­¥åˆ é™¤ä¸€ä¸ªæˆ–è€…å¤šä¸ªæŒ‡å®šçš„keyï¼Œredis4.0ä»¥ä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨SCANå‘½ä»¤ç»“åˆDELå‘½ä»¤æ¥ä»½æ‰¹æ¬¡åˆ é™¤ã€‚</p>
<p>3ã€<strong>é‡‡ç”¨åˆé€‚çš„æ•°æ®ç»“æ„</strong>ï¼šä¾‹å¦‚äºŒè¿›åˆ¶æ•°æ®ä¸ä½¿ç”¨Stringä¿å­˜ï¼Œä½¿ç”¨HyperLogLogç»Ÿè®¡é¡µé¢UV</p>
<p>4ã€<strong>å¼€å¯lazy-freeï¼ˆæƒ°æ€§åˆ é™¤&#x2F;å»¶è¿Ÿé‡Šæ”¾ï¼‰</strong>ï¼šlazy-freeç‰¹æ€§å¼redis4.0å¼€å§‹å¼•è¿›çš„ï¼ŒæŒ‡çš„æ˜¯è®©redisé‡‡ç”¨å¼‚æ­¥çš„æ–¹å¼å»¶è¿Ÿé‡Šæ”¾keyä½¿ç”¨çš„å†…å­˜ï¼Œå°†è¯¥æ“ä½œäº¤ç»™å•ç‹¬çš„å­çº¿ç¨‹å¤„ç†ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚</p>
<h3 id="æ•°æ®åº“"><a href="#æ•°æ®åº“" class="headerlink" title="æ•°æ®åº“"></a>æ•°æ®åº“</h3><h4 id="æ€ä¹ˆä¼˜åŒ–sql"><a href="#æ€ä¹ˆä¼˜åŒ–sql" class="headerlink" title="æ€ä¹ˆä¼˜åŒ–sql"></a>æ€ä¹ˆä¼˜åŒ–sql</h4><p>ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œæ‰€æœ‰æŸ¥è¯¢çš„ä¼˜åŒ–éƒ½æ˜¯åŸºäºåº•å±‚å­˜å‚¨ç»“æ„ã€‚</p>
<p>â€‹	1ã€innerbdæ˜¯ä»¥B+æ ‘çš„å½¢å¼ä¿å­˜çš„ï¼Œæ ¹æ®ç´¢å¼•å’Œidæ„å»ºäº†B+æ ‘ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æŸ¥è¯¢çš„æ—¶å€™è¦æ³¨æ„ä½¿ç”¨ç´¢å¼•ï¼Œè¿™æ ·å¯ä»¥æ›´å¿«çš„æ‰¾åˆ°æ•°æ®ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™è¦æ³¨æ„æœ€å·¦åŒ¹é…åŸåˆ™å’Œéšå¼è®¡ç®—ã€‚</p>
<p>â€‹	2ã€ç´¢å¼•B+æ•°æ®çš„å¶å­ç»“ç‚¹ä¿å­˜çš„åªæ˜¯æ•°æ®çš„idå¹¶ä¸æ˜¯æ•°æ®çš„æ‰€æœ‰å€¼ï¼Œæ‰€ä»¥å³ä½¿æ ¹æ®ç´¢å¼•æ‰¾åˆ°äº†æ•°æ®çš„å¶å­ç»“ç‚¹ï¼Œå¦‚æœå¶å­ç»“ç‚¹çš„å­—æ®µä¸å¤ŸæŸ¥è¯¢éœ€è¦ï¼Œè¿˜è¦æ ¹æ®idå»æ‰¾å…·ä½“æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšå›è¡¨ï¼Œä½†æ˜¯å¦‚æœå¶å­ç»“ç‚¹åŒ…å«çš„å­—æ®µå€¼å¤Ÿæˆ‘ä»¬æŸ¥è¯¢éœ€è¦ï¼Œå°±ä¸éœ€è¦å»æŸ¥è¯¢å…·ä½“æ•°æ®ï¼Œå‡å°‘äº†å›è¡¨è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p>â€‹	3ã€æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œæ ¹æ®æ‰§è¡Œè®¡åˆ’ä¼˜åŒ–sqlã€‚</p>
<h4 id="æ‰§è¡Œè®¡åˆ’æ€ä¹ˆæŸ¥çœ‹"><a href="#æ‰§è¡Œè®¡åˆ’æ€ä¹ˆæŸ¥çœ‹" class="headerlink" title="æ‰§è¡Œè®¡åˆ’æ€ä¹ˆæŸ¥çœ‹"></a>æ‰§è¡Œè®¡åˆ’æ€ä¹ˆæŸ¥çœ‹</h4><p><img src="/Users/xiaozhigang/blog/source/images/back-02-17/image-20250309103934302.png" alt="image-20250309103934302"></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/tannins_/article/details/140007565">https://blog.csdn.net/tannins_/article/details/140007565</a></p>
<p>æ¯”è¾ƒé‡è¦çš„å­—æ®µï¼š</p>
<p>select_typeï¼šæŸ¥è¯¢ç±»å‹ simple ç®€å•è¯­å¥ï¼Œ primary å¤æ‚æŸ¥è¯¢ï¼Œ union è”åˆæŸ¥è¯¢ ç­‰ç­‰</p>
<p>tableï¼šå¯¹åº”çš„è¡¨</p>
<p>typeï¼šç´¢å¼•ç±»å‹ï¼Œall &lt; index &lt; range &lt; eq_ref &lt; const &lt; system </p>
<p>possible_keyï¼šåˆ†ææ—¶å¯èƒ½ç”¨åˆ°çš„ç´¢å¼•</p>
<p>keyï¼šå®é™…ä½¿ç”¨çš„ç´¢å¼•</p>
<p>key_lenï¼šä½¿ç”¨åˆ°ç´¢å¼•çš„é•¿åº¦</p>
<p>refï¼šå“ªäº›åˆ—æˆ–è€…å¸¸é‡è¢«ç”¨äºæŸ¥æ‰¾ç´¢å¼•åˆ—ä¸Šçš„å€¼</p>
<p>rowï¼šä¼°ç®—æŸ¥æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„è®°å½•æ‰€éœ€è¦çš„è¯»å–çš„è¡Œæ•°</p>
<p>extraï¼šæ‰§è¡Œè®¡åˆ’çš„å…¶ä»–ä¿¡æ¯</p>
<h3 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h3><h4 id="çº¿ç¨‹æ± çš„å‚æ•°"><a href="#çº¿ç¨‹æ± çš„å‚æ•°" class="headerlink" title="çº¿ç¨‹æ± çš„å‚æ•°"></a>çº¿ç¨‹æ± çš„å‚æ•°</h4><p>ä¸¤ä¸ªçº¿ç¨‹æ•°ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°</p>
<p>ä¸¤ä¸ªåœç•™æ—¶é—´ç›¸å…³ï¼šåœç•™æ—¶é—´å€¼å’Œæ—¶é—´å•ä½</p>
<p>ä¸‰ä¸ªè¿‡ç¨‹ç›¸å…³ï¼šäº§ç”Ÿçš„å·¥å‚æ–¹æ³•ï¼Œæ’é˜Ÿçš„é˜Ÿåˆ—ï¼Œæ‹’ç»çš„ç­–ç•¥</p>
<h4 id="çº¿ç¨‹æ± å‚æ•°ä¸­çš„æ’åºé˜Ÿåˆ—çš„æ³¨æ„ç‚¹"><a href="#çº¿ç¨‹æ± å‚æ•°ä¸­çš„æ’åºé˜Ÿåˆ—çš„æ³¨æ„ç‚¹" class="headerlink" title="çº¿ç¨‹æ± å‚æ•°ä¸­çš„æ’åºé˜Ÿåˆ—çš„æ³¨æ„ç‚¹"></a>çº¿ç¨‹æ± å‚æ•°ä¸­çš„æ’åºé˜Ÿåˆ—çš„æ³¨æ„ç‚¹</h4><p>é˜Ÿåˆ—çš„é€‰æ‹©</p>
<p>â€‹	ä¸€èˆ¬åˆ†ä¸ºï¼šç›´æ¥æäº¤é˜Ÿåˆ—ï¼Œæœ‰ç•Œä»»åŠ¡é˜Ÿåˆ—ï¼Œæ— ç•Œä»»åŠ¡é˜Ÿåˆ—ï¼Œä¼˜å…ˆä»»åŠ¡é˜Ÿåˆ—ï¼Œå»¶è¿Ÿé˜Ÿåˆ—ã€‚</p>
<p>â€‹	SynchronousQueueï¼šç›´æ¥æäº¤é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—ä¸å­˜å‚¨ä»»ä½•å…ƒç´ ï¼Œç›´æ¥å°†æ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªå¯¹åº”çš„ç§»é™¤æ“ä½œï¼Œåä¹‹ä¾ç„¶ã€‚é€šå¸¸ç”¨äºåˆ›å»ºæ— ç•Œçº¿ç¨‹æ± ï¼Œæœ€å¤§çº¿ç¨‹æ•°å®é™…å–å†³äºç³»ç»Ÿæˆ–JVMçš„é™åˆ¶</p>
<p>â€‹	ArrayBlockingQueueï¼šæœ‰ç•Œé˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŸºäºæ•°æ®ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œæ–°å…ƒç´ æ’å…¥é˜Ÿåˆ—æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™æ’å…¥çº¿ç¨‹ä¼šè¢«é˜»å¡ç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰ç©ºé—´å¯ç”¨ã€‚ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œå¯ä»¥æ›´å¥½çš„æ§åˆ¶èµ„æºçš„ä½¿ç”¨é˜²æ­¢èµ„æºè€—å°½ã€‚</p>
<p>â€‹	LinkedBlockingQueueï¼šæ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„æ’åºè§„åˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºï¼Œä¸”é˜Ÿåˆ—çš„å®¹é‡Integer.MAX_VALUEï¼Œä½¿ç”¨æ— ç•Œé˜Ÿåˆ—æ—¶ï¼Œçº¿ç¨‹æ± çš„å¤§å°å°†åªå—åˆ°corePoolSizeçš„çº¦æŸï¼Œå› ä¸ºä»»åŠ¡å¯ä»¥åœ¨é˜Ÿåˆ—ä¸­æ— é™æœŸçš„æ‰§è¡Œç­‰å¾…ï¼Œç„¶è€Œï¼Œè¿™å¯èƒ½å¯¼è‡´èµ„æºè€—å°½ã€‚</p>
<p>â€‹	PriorityBlockingQueueï¼šä¼˜å…ˆé˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æ ¹æ®å…ƒç´ çš„ä¼˜å…ˆçº§è¿›è¡Œæ’åºï¼Œä¼˜å…ˆçº§é«˜çš„å…ƒç´ å…ˆè¢«ç§»é™¤ï¼Œå¯¹äºæŒ‰ä¼˜å…ˆçº§æ‰§è¡Œä»»åŠ¡çš„åº”ç”¨åœºæ™¯éå¸¸æœ‰ç”¨ã€‚</p>
<p>â€‹	DelayQueueï¼šå»¶è¿Ÿé˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—ä¸­çš„å…ƒç´ åªæœ‰å½“èµ·æŒ‡å®šå»¶è¿Ÿæ—¶é—´åˆ°äº†æ‰èƒ½å¤Ÿä»é˜Ÿåˆ—ä¸­è·å–åˆ°è¯¥å…ƒç´ </p>
<p>æ³¨æ„æ§åˆ¶é˜Ÿåˆ—çš„é•¿åº¦ï¼Œé¿å…é€ æˆå†…å­˜æº¢å‡º</p>
<h4 id="çº¿ç¨‹æ± ä¸­å…¬å¹³é”çš„çº¿ç¨‹æ˜¯æ€ä¹ˆå”¤é†’çš„"><a href="#çº¿ç¨‹æ± ä¸­å…¬å¹³é”çš„çº¿ç¨‹æ˜¯æ€ä¹ˆå”¤é†’çš„" class="headerlink" title="çº¿ç¨‹æ± ä¸­å…¬å¹³é”çš„çº¿ç¨‹æ˜¯æ€ä¹ˆå”¤é†’çš„"></a>çº¿ç¨‹æ± ä¸­å…¬å¹³é”çš„çº¿ç¨‹æ˜¯æ€ä¹ˆå”¤é†’çš„</h4><p>ç†è§£æœ‰ç‚¹é—®é¢˜ï¼Œå…¬å¹³é”æ˜¯æŒ‡ä¸€ä¸ªé”ï¼Œè€Œçº¿ç¨‹æ± æ˜¯ä¸€ä¸ªæ± ï¼Œçº¿ç¨‹æ± ä¸­çš„æ’åºé˜Ÿåˆ—æ˜¯å¯ä»¥æœ‰å¤šç§é˜Ÿåˆ—ï¼Œä½†æ˜¯é˜Ÿåˆ—çš„æœ¬è´¨è¿˜æ˜¯ä»å¤´éƒ¨è·å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥çº¿ç¨‹æ± è¿˜æ˜¯æ€»æ˜¯ä»é˜Ÿåˆ—ä¸­è·å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåªæ˜¯å¯èƒ½æœ‰æ’åºæ–¹å¼çš„ä¸ä¸€æ ·ï¼Œå¯¼è‡´ä¸ä¸€å®šæ˜¯å…ˆå…¥å…ˆå‡ºã€‚</p>
<h3 id="jvm"><a href="#jvm" class="headerlink" title="jvm"></a>jvm</h3><h4 id="cpué£™å‡æ€ä¹ˆæ’æŸ¥"><a href="#cpué£™å‡æ€ä¹ˆæ’æŸ¥" class="headerlink" title="cpué£™å‡æ€ä¹ˆæ’æŸ¥"></a>cpué£™å‡æ€ä¹ˆæ’æŸ¥</h4><p>1ã€ä½¿ç”¨topå‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿcpuå ç”¨æƒ…å†µï¼Œæ‰¾å‡ºå ç”¨æœ€é«˜çš„è¿›ç¨‹pid</p>
<p>2ã€ä½¿ç”¨å‘½ä»¤æŸ¥æ‰¾è¿›ç¨‹å†…å ç”¨cpuæœ€é«˜çš„çº¿ç¨‹idï¼šps H -eo pid,tid,%cpu | grep æœ€é«˜çš„è¿›ç¨‹pid</p>
<p>3ã€æ ¹ç»çº¿ç¨‹idæŸ¥æ‰¾å †æ ˆä¿¡æ¯ï¼Œæ³¨æ„è¦å°†çº¿ç¨‹idè½¬åŒ–æˆ16è¿›åˆ¶</p>
<p>4ã€åœ¨æ ¹æ®å †æ ˆä¿¡æ¯å®šä½é—®é¢˜</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/18/dify%E8%BF%9E%E6%8E%A5deepseek/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaozhigang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaozhigang">
      <meta itemprop="description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | xiaozhigang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/11/18/dify%E8%BF%9E%E6%8E%A5deepseek/" class="post-title-link" itemprop="url">difyé€šè¿‡ollamaè¿æ¥deepseek</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2024-11-18 22:28:27" itemprop="dateCreated datePublished" datetime="2024-11-18T22:28:27+08:00">2024-11-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/AI/" itemprop="url" rel="index"><span itemprop="name">AI</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>é¦–å…ˆæˆ‘ä»¬å¾—æ˜ç™½ä¸€ä¸‹æ¦‚å¿µï¼Œdifyã€ollamaã€deepseekéƒ½æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>difyï¼šä¸€ä¸ªå¹³å°ï¼Œä¸€ä¸ªç®€å•æ˜“ç”¨å¼€æºçš„LLMOps(Language Model Operations)å¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢å¯è§†åŒ–çš„å¼€å‘ç¼–æ’AIåº”ç”¨ã€‚</p>
<p>ollamaï¼šä¸€ä¸ªå¼€æºçš„å¤§æ¨¡å‹æœåŠ¡å·¥å…·ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿåœ¨æœ¬åœ°è¿è¡Œå¤§æ¨¡å‹ã€‚</p>
<p>deepseekï¼šå›½äº§çš„å¤§æ¨¡å‹ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬è¦åœ¨difyç¼–æ’å¤§æ¨¡å‹åº”ç”¨ï¼Œå°±éœ€è¦æœ‰ä¸€ä¸ªå¤§æ¨¡å‹ï¼Œè€Œollamaåˆšå¥½å¯ä»¥å¸®æˆ‘éƒ¨ç½²è¿è¡Œå¤§æ¨¡å‹ã€‚æ‰€ä»¥ollamaåœ¨è¿™é‡Œæ›´åƒæ˜¯difyå¹³å°å’Œdeepseekå¤§æ¨¡å‹ä¹‹é—´çš„è¿æ¥å·¥å…·ã€‚</p>
<h3 id="ollamaå®‰è£…"><a href="#ollamaå®‰è£…" class="headerlink" title="ollamaå®‰è£…"></a>ollamaå®‰è£…</h3><p>å¯ä»¥åœ¨ollamaå®˜ç½‘ç›´æ¥ä¸‹è½½å®‰è£…<a target="_blank" rel="noopener" href="https://ollama.com/%E3%80%82">https://ollama.com/ã€‚</a></p>
<p>linuxå®‰è£…å‘½ä»¤ï¼šcurl -fsSL <a target="_blank" rel="noopener" href="https://ollama.com/install.sh">https://ollama.com/install.sh</a> | sh</p>
<p>å®‰è£…ä¹‹åå¯ä»¥é€šè¿‡ ollama -v å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å®‰è£…å¥½ã€‚</p>
<p><img src="/../images/dify-ollama-deepseek/image-ollama-install.png" alt="image-20250320165712115"></p>
<p>ollamaçš„é»˜è®¤ç«¯å£æ˜¯11434ï¼Œå®‰è£…å®Œå¯ä»¥é€šè¿‡æµè§ˆå™¨æ‰“å¼€ipå’Œportç•Œé¢ï¼Œå¯ä»¥çœ‹åˆ°ç•Œé¢æç¤º ollama is running</p>
<p><img src="/../images/dify-ollama-deepseek/image-ollama-port.png" alt="image-20250320172632758"></p>
<p>æœ‰é»˜è®¤ç«¯å£ï¼Œå°±å¯ä»¥æ”¹ç«¯å£ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹å¯åŠ¨æ–‡ä»¶ï¼Œä»è€Œåˆ¶å®šç«¯å£</p>
<p>vim &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;ollama.service</p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘æŒ‡å®šäº†9876ç«¯å£</p>
<p><img src="/../images/dify-ollama-deepseek/image-ollama-change-port.png" alt="image-20250320172913316"></p>
<h3 id="deepseekå®‰è£…"><a href="#deepseekå®‰è£…" class="headerlink" title="deepseekå®‰è£…"></a>deepseekå®‰è£…</h3><p>ç›´æ¥è¿è¡Œollama run deepseek-r1:7bå‘½ä»¤æŒ‰è½¬ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å®‰è£…å…¶ä»–ç‰ˆæœ¬æˆ–è€…å…¶ä»–å‚å•†çš„å¤§æ¨¡å‹ã€‚</p>
<p><img src="/../images/dify-ollama-deepseek/image-deepseek-inastll.png" alt="image-20250320170141452"></p>
<h3 id="difyå®‰è£…"><a href="#difyå®‰è£…" class="headerlink" title="difyå®‰è£…"></a>difyå®‰è£…</h3><p>è¿™é‡Œæˆ‘æ˜¯é€šè¿‡dockerå®‰è£…çš„ï¼Œdockerçš„å®‰è£…è¿‡ç¨‹å°±è¯¦ç»†å±•ç¤ºï¼Œå¯è‡ªè¡Œæœç´¢æ•™ç¨‹å®‰è£…dockerã€‚</p>
<p>difyçš„å®‰è£…å‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/langgenius/dify.git</span><br><span class="line">cd dify/docker</span><br><span class="line">cp .env.example .env</span><br><span class="line">docker compose up -d </span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­difyé»˜è®¤çš„ç«¯å£æ˜¯80ï¼Œæˆ‘ä»¬è¦æƒ³ä¿®æ”¹ç«¯å£çš„è¯ï¼Œå¯ä»¥åœ¨ .env ç¯å¢ƒé…ç½®ä¸­ä¿®æ”¹ç«¯å£å·ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæˆ‘æ”¹æˆäº†8080ã€‚æ”¹å®Œé‡å¯dify</p>
<p><img src="/../images/dify-ollama-deepseek/image-dify-port.png" alt="image-20250320170830107"></p>
<h3 id="difyè¿æ¥deepseek"><a href="#difyè¿æ¥deepseek" class="headerlink" title="difyè¿æ¥deepseek"></a>difyè¿æ¥deepseek</h3><p>é€šè¿‡æµè§ˆå™¨æ‰“å¼€ <a href="http://ip:port">http://ip:port</a> ç•Œé¢  ipä¸ºè‡ªå·±ä¸»æœºipï¼Œportä¸ºä¸Šé¢è‡ªå·±è®¾ç½®çš„portã€‚åœ¨ä¸€ç³»åˆ—è´¦å·å¯†ç æ³¨å†Œä¹‹ååˆ°ä¸»é¡µé¢ã€‚åœ¨ä¸»é¡µé¢çš„ä¸ªäººè´¦å·ä¸‹è®¾ç½®é‡Œé…ç½®å¤§æ¨¡å‹ã€‚<img src="/../images/dify-ollama-deepseek/image-dify-setting.png" alt="image-20250320171734695"></p>
<p>åœ¨settingé‡Œé¢ï¼Œæ‰¾åˆ°æ¨¡å‹å‚å•†ï¼ˆModel Providerï¼‰ï¼Œåœ¨ä¸‹é¢çš„ to be configured çš„é…ç½®ä¸­æ‰¾åˆ°ollamaçš„é…ç½®ï¼Œå®‰è£…å¥½æ’ä»¶é…ç½®ï¼ŒæˆåŠŸå®‰è£…åå¦‚å›¾ã€‚</p>
<p><img src="/../images/dify-ollama-deepseek/image-plug-install.png" alt="image-20250320172145700"></p>
<p>åœ¨å³ä¸‹è§’ä¸­çš„Add modelä¸­æ·»åŠ æ¨¡å‹ã€‚</p>
<p><img src="/../images/dify-ollama-deepseek/image-dify-add-model.png" alt="image-20250320173110641"></p>
<p>model nameï¼šä¸€å®šè¦æ³¨æ„ï¼Œå†™çš„æ˜¯å…·ä½“éƒ¨ç½²çš„æ¨¡å‹å‹å·ï¼Œæˆ‘ä»¬éƒ¨ç½²çš„deepseek-r1:7bï¼Œé‚£è¿™é‡Œä¹Ÿè¦å¡«å†™deepseek-r1:7bï¼Œå¼€å§‹æˆ‘ä»¥ä¸ºå¯ä»¥éšæ„å‘½åï¼Œç»“æœæäº†åŠå¤©éƒ½æ²¡è¿æ¥ä¸Šã€‚</p>
<p>base urlï¼šå¡«å†™ä¸Šé¢ollamaå¯ä»¥åœ¨æµè§ˆå™¨æ‰“å¼€çš„åœ°å€ã€‚</p>
<p>è¿æ¥å®Œå°±å¯ä»¥ä½¿ç”¨äº†ï¼Œåé¢å†åˆ†äº«æ€ä¹ˆæ„å»ºçŸ¥è¯†åº“æ€ä¹ˆä½¿ç”¨ã€‚</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/11/minio%E5%A4%8D%E5%88%B6%E5%A4%87%E4%BB%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaozhigang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaozhigang">
      <meta itemprop="description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | xiaozhigang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/11/minio%E5%A4%8D%E5%88%B6%E5%A4%87%E4%BB%BD/" class="post-title-link" itemprop="url">minioå¤åˆ¶å¤‡ä»½</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2024-10-11 21:39:52 / ä¿®æ”¹æ—¶é—´ï¼š22:09:36" itemprop="dateCreated datePublished" datetime="2024-10-11T21:39:52+08:00">2024-10-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">ä¸­é—´ä»¶</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h2><p>å®ç°å¤‡ä»½ï¼Œå°†æºminioæ•°æ®å¤‡ä»½åˆ°å…¶ä»–minioä¸Šã€‚</p>
<h2 id="å…ˆå†³æ¡ä»¶"><a href="#å…ˆå†³æ¡ä»¶" class="headerlink" title="å…ˆå†³æ¡ä»¶"></a>å…ˆå†³æ¡ä»¶</h2><p>1ã€minioç‰ˆæœ¬ç›¸åŒï¼Œæœ€å¥½ç›¸åŒï¼Œå¦‚æœç‰ˆæœ¬ä¸åŒå¯èƒ½ä¼šå‘ç”ŸæœªçŸ¥é”™è¯¯ã€‚</p>
<p>2ã€ç«™ç‚¹å¤åˆ¶éœ€è¦å¼€å¯æ¡¶çº§åˆ«ç‰ˆæœ¬æ§åˆ¶ï¼ˆBucket Versioningï¼‰ï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨å¼€å¯å·²åˆ›å»ºçš„Bucketçš„ç‰ˆæœ¬æ§åˆ¶ã€‚ä¸å¯ä»¥å…³é—­ç«™ç‚¹å¤åˆ¶çš„MinIOéƒ¨ç½²ä¸Šçš„ç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½ã€‚</p>
<p><img src="/../images/minio/minio-bucket.png" alt="image-20241011222201154"></p>
<p>3ã€æºminioä¸­æœ‰Bucketï¼Œå¹¶ä¸”æœ‰æ•°æ®ã€‚ç›®æ ‡minioä¸­æ²¡æœ‰ä»»ä½•Bucketå’ŒObjectã€‚</p>
<p>4ã€æºminioå’Œç›®æ ‡minioæœ€å¥½æœ‰ç›¸åŒçš„IDPï¼ŒIDPå¯åœ¨é¡µé¢è®¾ç½®ï¼Œä¸”è®¾ç½®è¶³å¤Ÿçš„æƒé™ã€‚</p>
<p><img src="/../images/minio/minio-user.png" alt="image-20241011222424095"></p>
<h2 id="æ“ä½œè®¾ç½®"><a href="#æ“ä½œè®¾ç½®" class="headerlink" title="æ“ä½œè®¾ç½®"></a>æ“ä½œè®¾ç½®</h2><p>é¡µé¢ä¸Šç›´æ¥æ·»åŠ å¤‡ä»½minioï¼Œè®¾ç½®å¥½urlå’Œè´¦å·å¯†ç å³å¯ã€‚</p>
<p><img src="/../images/minio/minio-site-1.png" alt="image-20241011222607409"></p>
<p>æ³¨æ„å¦‚æœå·²ç»æœ‰å¤‡ä»½ç«™ç‚¹äº†ï¼Œéœ€è¦å†æ·»åŠ ä¸€ä¸ªçš„è¯ï¼Œéœ€è¦ä¿ç•™åŸæœ‰ç«™ç‚¹ï¼Œåœ¨peer sitesæ ä¸‹é¢ç‚¹å‡»åŠ å·æŒ‰é’®æ–°åŠ ä¸€ä¸ªï¼Œå¦‚ä¸‹å›¾ã€‚</p>
<p><img src="/../images/minio/minio-site-2.png" alt="image-20241013111252255"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/03/spider%E7%88%AC%E8%99%AB%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaozhigang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaozhigang">
      <meta itemprop="description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | xiaozhigang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/10/03/spider%E7%88%AC%E8%99%AB%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">çˆ¬è™«å®‰è£…æŒ‡å—</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2024-10-03 11:30:33" itemprop="dateCreated datePublished" datetime="2024-10-03T11:30:33+08:00">2024-10-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="å®‰è£…éƒ¨ç½²æŒ‡å—"><a href="#å®‰è£…éƒ¨ç½²æŒ‡å—" class="headerlink" title="å®‰è£…éƒ¨ç½²æŒ‡å—"></a>å®‰è£…éƒ¨ç½²æŒ‡å—</h1><p>å¼€å‘è¿‡ç¨‹å‡ä½¿ç”¨çš„Ubuntuï¼Œä¸‹é¢è¯´æ˜æŒ‡å—å‡åŸºäºUbuntuä½¿ç”¨ã€‚</p>
<h3 id="ä¸­é—´ä»¶å®‰è£…"><a href="#ä¸­é—´ä»¶å®‰è£…" class="headerlink" title="ä¸­é—´ä»¶å®‰è£…"></a>ä¸­é—´ä»¶å®‰è£…</h3><p>éœ€è¦å®‰è£… redisï¼Œmysqlï¼Œminioï¼Œrabbitmq è‡ªè¡Œæœç´¢ï¼ŒæœåŠ¡å™¨å®‰è£…å³å¯ã€‚</p>
<p>rediså‚è€ƒé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1639658">https://cloud.tencent.com/developer/article/1639658</a></p>
<p>mysqlå‚è€ƒé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/xz2005/article/details/130145465">https://blog.csdn.net/xz2005/article/details/130145465</a></p>
<p>minioå‚è€ƒé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/hunttown/p/17358797.html">https://www.cnblogs.com/hunttown/p/17358797.html</a></p>
<p>rabbitmqå‚è€ƒé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/hunttown/p/17352729.html">https://www.cnblogs.com/hunttown/p/17352729.html</a></p>
<p>å®‰è£…éªŒè¯ï¼šrediså’Œmysqlå¯ç”¨æœ¬åœ°è¿æ¥å·¥å…·å¯è¿æ¥ä½¿ç”¨ï¼Œminioå’Œrabbitmqå‡æœ‰å¯è§†åŒ–ç•Œé¢ï¼Œå¯åœ¨å¯è§†åŒ–ç•Œé¢ç™»é™†æ‰“å¼€ã€‚</p>
<p>æ³¨æ„ï¼šæ³¨æ„æœåŠ¡å™¨çš„ç«¯å£æœ‰æ²¡æœ‰æ‰“å¼€</p>
<p>æœåŠ¡å™¨43.154.80.35ä¸­å·²æœ‰å®‰è£…å¥½çš„ä¸­é—´ä»¶ï¼Œå¯ç›´æ¥ä½¿ç”¨ï¼Œè´¦å·å¯†ç ï¼Œä»£ç ä¸­çš„setting.pyæ–‡ä»¶ä¸­éƒ½æœ‰ï¼Œå¦‚æœè¦ä¿®æ”¹æˆå…¶ä»–åœ°å€ä¸­é—´ä»¶ï¼Œå¯ç›´æ¥åœ¨replace.pyä¸­ä¿®æ”¹ç›¸åº”å­—æ®µï¼Œè¿è¡Œç»Ÿä¸€ä¿®æ”¹ã€‚</p>
<p>æ³¨ï¼šç°åœ¨settings.pyæ–‡ä»¶è®¾ç½®çš„æ˜¯æœåŠ¡å™¨43.154.80.35çš„å†…ç½‘ipï¼ŒæœåŠ¡å™¨è´¦å·å¯†ç å’Œå„ä¸­é—´ä»¶è´¦å·å¯†ç ç§ä¿¡å‘é€ã€‚</p>
<h3 id="ç½‘ç»œç¯å¢ƒå®‰è£…"><a href="#ç½‘ç»œç¯å¢ƒå®‰è£…" class="headerlink" title="ç½‘ç»œç¯å¢ƒå®‰è£…"></a>ç½‘ç»œç¯å¢ƒå®‰è£…</h3><h4 id="æœåŠ¡å™¨è¦æ±‚ï¼Œ"><a href="#æœåŠ¡å™¨è¦æ±‚ï¼Œ" class="headerlink" title="æœåŠ¡å™¨è¦æ±‚ï¼Œ"></a>æœåŠ¡å™¨è¦æ±‚ï¼Œ</h4><p>å¤–ç½‘ï¼Œubuntu</p>
<h4 id="å®‰è£…è½¯ä»¶"><a href="#å®‰è£…è½¯ä»¶" class="headerlink" title="å®‰è£…è½¯ä»¶"></a>å®‰è£…è½¯ä»¶</h4><p>privoxyï¼Œtorï¼Œobfs4proxy</p>
<pre class="mermaid">graph LR

a[ä»£ç ]--8118ç«¯å£-->b[privoxy]--9050ç«¯å£-->c[tor]--ç½‘æ¡¥/obfs4proxy-->d[æš—ç½‘]</pre>



<h5 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h5><p>è§£å‹å‹ç¼©åŒ…ï¼Œç½‘ç«™ç›®å½•ä¸‹çš„settingæ–‡ä»¶ä¸­é…ç½®äº†ä»£ç†ç«¯å£ï¼Œå°†è¯·æ±‚å‘é€åˆ°æœ¬çº§çš„8118ç«¯å£</p>
<p><img src="/../images/spider/image-proxy-code.png" alt="image-20240828231130808"></p>
<h5 id="privoxy"><a href="#privoxy" class="headerlink" title="privoxy"></a>privoxy</h5><p>1ã€å®‰è£…ï¼šsudo apt-get install privoxy</p>
<p>2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š</p>
<p>â€‹	è¿›å…¥é…ç½®æ–‡ä»¶  vim &#x2F;etc&#x2F;privoxy&#x2F;config</p>
<p>â€‹	ä¿®æ”¹æ¥æ”¶ä»£ç†ï¼šlisten-address 127.0.0.1:8118</p>
<p>â€‹	ä¿®æ”¹è½¬å‘æ•°æ®ï¼šæœ€åä¸€è¡Œæ·»åŠ  forward-socks5t   &#x2F;               127.0.0.1:9050 .  ï¼ˆæ³¨æ„æœ€åçš„ç‚¹ä¸èƒ½ä¸¢ï¼‰</p>
<p><img src="/../images/spider/image-privoxy-config.png" alt="image-20240828232233501"></p>
<p><img src="/../images/spider/image-privoxy-config-9050.png" alt="image-20240828232433118"></p>
<p>â€‹	é…ç½®å®Œé‡å¯ä½¿é…ç½®ç”Ÿæ•ˆ</p>
<h5 id="tor"><a href="#tor" class="headerlink" title="tor"></a>tor</h5><p>1ã€å®‰è£…torï¼šsudo apt-get install tor</p>
<p>2ã€å®‰è£…obfs4proxyï¼š sudo apt-get install obfs4proxy</p>
<p>3ã€toré…ç½®æ–‡ä»¶ä¸­æ·»åŠ ç½‘æ¡¥ï¼Œvi &#x2F;etc&#x2F;tor&#x2F;torrcï¼Œè¿›è¡Œå¦‚å›¾é…ç½®</p>
<p>â€‹	æŸ¥çœ‹tor 9050ç«¯å£æ˜¯å¦æ‰“å¼€ï¼Œè‹¥æ²¡æœ‰æ‰“å¼€ï¼Œå»æ‰æ³¨é‡Šæ‰“å¼€ç«¯å£</p>
<p><img src="/../images/spider/image-tor-port.png" alt="image-20241003092814823"></p>
<p>â€‹	é…ç½®obfs4proxy</p>
<p>â€‹	é…ç½®ç½‘æ¡¥ï¼Œåœ°å€å¯ç”¨ obfs4 51.178.86.168:54874 773A7F4428AE519A892152EDA963477D85EE672A cert&#x3D;xghcVpPhAAktkvVpYY6LDsE5iVayo4ADztSEwj0YcqGERxr3+v+RqScaOCC1O&#x2F;uxeZinWA iat-mode&#x3D;0ï¼Œå»ºè®®å¤šç”³è¯·å‡ ä¸ªåšå¤‡ç”¨ï¼Œç½‘æ¡¥ä¹Ÿä¼šè¿‡æœŸä¸å¯ç”¨</p>
<p><img src="/../images/spider/image-tor-config.png" alt="image-20240828232652882"></p>
<p>â€‹	é…ç½®å®Œé‡å¯ä½¿é…ç½®ç”Ÿæ•ˆ</p>
<h4 id="éªŒè¯ç½‘ç»œé€šè·¯"><a href="#éªŒè¯ç½‘ç»œé€šè·¯" class="headerlink" title="éªŒè¯ç½‘ç»œé€šè·¯"></a>éªŒè¯ç½‘ç»œé€šè·¯</h4><p>æ£€æµ‹privoxyç«¯å£ä½¿ç”¨ï¼šnetstat -an | grep 8118</p>
<p>æ£€æµ‹torç«¯å£ä½¿ç”¨ï¼šnetstat -an | grep 9050</p>
<p>æ£€æµ‹æ•´ä¸ªç½‘ç»œé€šè·¯ï¼šcurl -x <a target="_blank" rel="noopener" href="http://127.0.0.1:8118/">http://127.0.0.1:8118</a> <a target="_blank" rel="noopener" href="http://u5lyidiw4lpkonoctpqzxgyk6xop7w7w3oho4dzzsi272rwnjhyx7ayd.onion/">http://u5lyidiw4lpkonoctpqzxgyk6xop7w7w3oho4dzzsi272rwnjhyx7ayd.onion/</a></p>
<p>é€šè·¯æˆªå›¾ï¼š</p>
<p><img src="/../images/spider/image-link.png" alt="image-20241003091320866"></p>
<h3 id="é©±åŠ¨å®‰è£…"><a href="#é©±åŠ¨å®‰è£…" class="headerlink" title="é©±åŠ¨å®‰è£…"></a>é©±åŠ¨å®‰è£…</h3><h4 id="chromeå’Œchromedriverå®‰è£…"><a href="#chromeå’Œchromedriverå®‰è£…" class="headerlink" title="chromeå’Œchromedriverå®‰è£…"></a>chromeå’Œchromedriverå®‰è£…</h4><p>å¯å€Ÿé‰´ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44184990/article/details/123590435">https://blog.csdn.net/weixin_44184990/article/details/123590435</a></p>
<p>Google-chromeï¼šç‰ˆæœ¬- Google Chrome 127.0.6533.88</p>
<p>Chromedriverï¼šç‰ˆæœ¬- ChromeDriver 127.0.6533.88</p>
<p>å®‰è£…è·¯å¾„ï¼š&#x2F;usr&#x2F;bin&#x2F;</p>
<h3 id="è™šæ‹Ÿç¯å¢ƒå®‰è£…"><a href="#è™šæ‹Ÿç¯å¢ƒå®‰è£…" class="headerlink" title="è™šæ‹Ÿç¯å¢ƒå®‰è£…"></a>è™šæ‹Ÿç¯å¢ƒå®‰è£…</h3><p>pythonç¯å¢ƒï¼šå®‰è£…pythonï¼Œå¯å‚è€ƒ<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45536969/article/details/130124934">https://blog.csdn.net/qq_45536969/article/details/130124934</a></p>
<p>è™šæ‹Ÿç¯å¢ƒï¼š</p>
<p>â€‹	å®‰è£…è™šæ‹Ÿç¯å¢ƒï¼šå®‰è£…å¯å‚è€ƒ<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_64880493/article/details/132964831">https://blog.csdn.net/m0_64880493/article/details/132964831</a></p>
<p>â€‹	å®‰è£…ä¾èµ–ï¼šå®‰è£…requirements.txtæ–‡ä»¶ä¸­çš„æ‰€æœ‰ä¾èµ–  pip install -r requirements.txt </p>
<h3 id="ä»£ç è¿è¡Œ"><a href="#ä»£ç è¿è¡Œ" class="headerlink" title="ä»£ç è¿è¡Œ"></a>ä»£ç è¿è¡Œ</h3><p>ä»¥ä¸‹å‡ä»¥43.154.148.210æœåŠ¡å™¨ä¸ºä¾‹</p>
<p>1ã€æ‰“å¼€è™šæ‹Ÿç¯å¢ƒï¼Œè™šæ‹Ÿç¯å¢ƒåœ¨ &#x2F;opt&#x2F;dwSpiders&#x2F;dw-env&#x2F;bin&#x2F;ä¸‹ï¼Œå‘½ä»¤ï¼šsource &#x2F;opt&#x2F;dwSpiders&#x2F;dw-env&#x2F;bin&#x2F;activateï¼Œå„è‡ªå®‰è£…çš„ç›®å½•åœ°å€ä¸ä¸€æ ·ï¼Œéœ€è¦ä¿®æ”¹å‘½ä¸­çš„è·¯å¾„ï¼Œ</p>
<p>2ã€è¿›å…¥ç½‘ç«™ç›®å½•ï¼Œä»¥torrezç½‘ç«™ä¸ºä¾‹ï¼Œå‘½ä»¤ï¼šcd &#x2F;opt&#x2F;dwSpiders&#x2F;torrez</p>
<p>3ã€æ·»åŠ ä¿®æ”¹cookieï¼Œ43.154.80.35æœåŠ¡å™¨ä¸Šçš„redisä¸­æœ‰ç¤ºä¾‹ï¼Œä½¿ç”¨torç™»é™†åå¯æŒ‰ç¤ºä¾‹å°†cookieå¡«å†™åˆ°è‡ªå·±çš„redisä¸­ï¼ˆæ³¨ï¼šleakbaseç½‘ç«™æ²¡æœ‰éªŒè¯ç ï¼Œç™»é™†é€»è¾‘å·²ç»å†™å¥½ï¼Œç›´æ¥ç¬¬4æ­¥è¿è¡Œå³å¯ï¼‰</p>
<p><img src="/../images/spider/image-torrez-cookie.png" alt="image-20240902223652351"></p>
<p>4ã€å¯åŠ¨ä»£ç ï¼špython3 run_torrez.py &amp; </p>
<p>5ã€æŸ¥çœ‹æ—¥å¿—ï¼šå¦‚æœå½“å‰çª—å£è¿è¡Œä»£ç ï¼Œåˆ™ä¼šè‡ªåŠ¨å¼¹å‡ºæ—¥å¿—ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è¿›å…¥ç½‘ç«™ç›®å½•ä¸‹çš„logsç›®å½•ï¼ŒæŸ¥çœ‹å½“å‰æ—¥æœŸæ—¥å¿—æ–‡ä»¶ã€‚</p>
<p>6ã€cookieè¿‡æœŸï¼šç½‘ç«™çš„cookieä¼šè¿‡æœŸï¼Œè¿‡æœŸåç›´æ¥åœ¨redisåº“ä¸­æ›¿æ¢å°±è¡Œ</p>
<p>7ã€å¦‚éœ€è¦é‡è·‘ï¼Œéœ€è¦åˆ é™¤redisç›¸åº”ç½‘ç«™ä¸‹dupefilterå’Œbloom_fliter_imgï¼Œè¿™æ˜¯urlè¯·æ±‚çš„æŒ‡çº¹å’Œå›¾ç‰‡çš„è¯·æ±‚æŒ‡çº¹ï¼Œå»é‡ä½¿ç”¨ã€‚</p>
<p>8ã€mqçš„ä½¿ç”¨ï¼Œåœ¨æ¯ä¸ªç½‘ç«™ç›®å½•ä¸‹éƒ½åŠ äº†mqçš„é…ç½®ï¼Œå¦‚è¦ä½¿ç”¨ï¼Œåœ¨settingæ–‡ä»¶ä¸­æ‰“å¼€å³å¯</p>
<p><img src="/../images/spider/setting-mq.png" alt="image-20240902523652351"></p>
<p>9ã€ä¸å»ºè®®ä½¿ç”¨start.shç»Ÿä¸€å¯åŠ¨ï¼Œå¯è¿›å…¥å„è‡ªç½‘ç«™ç›®å½•ä¸‹å•ç‹¬å¯åŠ¨è¿è¡Œï¼Œæ ¹æ®ä¸åŒçš„æœåŠ¡å™¨ç›®å½•ï¼Œstart.shéœ€è¦é…ç½®ä¸åŒçš„è™šæ‹Ÿç¯å¢ƒç›®å½•å’Œä»£ç ç›®å½•</p>
<h3 id="ä¸­é—´ä»¶åˆå§‹åŒ–"><a href="#ä¸­é—´ä»¶åˆå§‹åŒ–" class="headerlink" title="ä¸­é—´ä»¶åˆå§‹åŒ–"></a>ä¸­é—´ä»¶åˆå§‹åŒ–</h3><h4 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h4><p>MySQLçš„åˆå§‹åŒ–æ¯”è¾ƒç®€å•ï¼Œåœ¨å®‰è£…å¥½çš„MySQLä¸­å®‰è£… dw-spider åº“ï¼Œåº“ä¸­éœ€è¦æ–°å»º5å¼ è¡¨ï¼ˆgoodsã€original_pageã€postã€siteã€userï¼‰ï¼Œå¦‚å›¾ã€‚å»ºè¡¨è¯­å¥ä»£ç dbç›®å½•ä¸‹æœ‰ã€‚</p>
<p><img src="/../images/spider/table.png" alt="image-20240902223652352"></p>
<h4 id="minio"><a href="#minio" class="headerlink" title="minio"></a>minio</h4><p>minioçš„åˆå§‹åŒ–ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåœ¨å…¶ä¸­æ–°å»ºdw-bucketï¼Œå¦‚å›¾ã€‚</p>
<p><img src="/../images/spider/dw-bucket.png" alt="image-20240902223652353"></p>
<h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><p>redisä¸­éœ€è¦é¢„ç½®8ä¸ªç½‘ç«™çš„cookieï¼šOnniforumsã€asapã€breachforumsã€darkdockã€dreadã€mgmgrandã€nexusã€torrez</p>
<p>redisçš„keyä¸º   ç½‘ç«™åç§°:ç½‘ç«™åç§°_cookieï¼Œç¤ºä¾‹ï¼šasap:asap_cookie</p>
<p>redisçš„valueä¸º  hashç±»å‹çš„é”®å€¼å¯¹ï¼Œå¦‚å›¾</p>
<p>Onniforumsï¼š<img src="/../images/spider/cookie-onni.png" alt="image-20240902223652354"></p>
<p>asapï¼š<img src="/../images/spider/cookie-asap.png" alt="image-20240902223652355"></p>
<p>breachforumsï¼š<img src="/../images/spider/cookie-bf.png" alt="image-20240902223652356"></p>
<p>darkdockï¼š<img src="/../images/spider/cookie-darkdock.png" alt="image-20240902223652357"></p>
<p>dreadï¼š<img src="/../images/spider/cookie-dread.png" alt="image-20240902223652358"></p>
<p>mgmgrandï¼š<img src="/../images/spider/cookie-mgm.png" alt="image-20240902223652359"></p>
<p>nexusï¼š<img src="/../images/spider/cookie-nexus.png" alt="image-20240902223652360"></p>
<p>torrezï¼š<img src="/../images/spider/cookie-torrez.png" alt="image-20240902223652361"></p>
<p>ä¸‹å›¾ä¸ºä»£ç è¿è¡Œåçš„redisæˆªå›¾ï¼Œå…¶ä¸­æˆªäº†torrezç½‘ç«™å’Œå•ç‹¬çš„bloom_filter_imgã€‚</p>
<p>bloom_filter_imgï¼šä¸ºæ‰€æœ‰å›¾ç‰‡è¯·æ±‚è¿‡æ»¤æ‰€ç”¨ï¼Œå†…å­˜æ”¾æ‰€æœ‰å·²è¯·æ±‚çš„å›¾ç‰‡åœ°å€ï¼Œå…¶å†…å­˜æ”¾çš„å›¾ç‰‡åœ°å€ä¸ä¼šäºŒæ¬¡è¯·æ±‚ï¼Œå¦‚æœé‡è·‘éœ€åˆ é™¤ï¼Œä»£ç è¿è¡Œåä¼šè‡ªè¡Œæ·»åŠ ã€‚</p>
<p>dupefilterï¼šä¸ºç«™å†…åœ°å€è¯·æ±‚è¿‡æ»¤æ‰€æœ‰ï¼Œå†…å­˜æ”¾æ‰€æœ‰å·²è¯·æ±‚çš„åœ°å€hashå€¼ï¼Œå…¶å†…å·²å­˜æ”¾çš„åœ°å€ä¸ä¼šäºŒæ¬¡è¯·æ±‚ï¼Œå¦‚æœé‡è·‘éœ€è¦åˆ é™¤ï¼Œä»£ç è¿è¡Œåä¼šè‡ªåŠ¨æ·»åŠ ã€‚</p>
<p>start_urlsï¼šä¸ºä»£ç è¿è¡Œæ—¶ï¼Œèµ·å§‹è¯·æ±‚çš„åœ°å€ï¼Œé‡è·‘æ—¶éœ€è¦åˆ é™¤ï¼Œè¿è¡Œåä¼šè‡ªåŠ¨æ·»åŠ ï¼Œèµ·å§‹åœ°å€è¯·æ±‚åä¼šè‡ªåŠ¨åˆ é™¤ã€‚</p>
<p>torrez_cookieï¼šä¸ºç½‘ç«™cookieï¼Œè¿è¡Œæ—¶éœ€è¦æ·»åŠ ï¼Œä¸”ä¿è¯cookieåœ¨æœ‰æ•ˆæœŸå†…ã€‚</p>
<p><img src="/../images/spider/image-2redis.png" alt="image-20240928172856612"></p>
<h4 id="rabbitmq"><a href="#rabbitmq" class="headerlink" title="rabbitmq"></a>rabbitmq</h4><p>éœ€è¦æ–°å»º5ä¸ªé˜Ÿåˆ—ï¼šgoodsã€pageã€postã€siteã€userã€‚</p>
<p>å¯åœ¨å¯è§†åŒ–ç•Œé¢æ–°å»ºï¼Œå¦‚å›¾ã€‚</p>
<p><img src="/../images/spider/mq-queues.png" alt="image-20240902223652361"></p>
<p>å…¶åˆå§‹äº¤æ¢æœºä¸ºscrapyï¼Œæ— éœ€é…ç½®ï¼Œä»£ç è¿è¡Œæ—¶ä¼šè‡ªåŠ¨é…ç½®ã€‚</p>
<p>æ³¨ï¼šæ¯ä¸ªé˜Ÿåˆ—éƒ½åœ¨æ¯ä¸ªç½‘ç«™çš„mqPipeline.pyæ–‡ä»¶ä¸­ç»‘å®šï¼Œä¸å»ºè®®ä¿®æ”¹ã€‚</p>
<h4 id="ä¸­é—´ä»¶é…ç½®ä¿®æ”¹"><a href="#ä¸­é—´ä»¶é…ç½®ä¿®æ”¹" class="headerlink" title="ä¸­é—´ä»¶é…ç½®ä¿®æ”¹"></a>ä¸­é—´ä»¶é…ç½®ä¿®æ”¹</h4><p>ä»£ç ä¸­æœ‰replace.pyæ–‡ä»¶ï¼Œè¿è¡Œæ¬¡æ–‡ä»¶å¯ç»Ÿä¸€ä¿®æ”¹å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„setting.pyæ–‡ä»¶ä¸­çš„ä¸­é—´ä»¶é…ç½®ã€‚replcae.pyä¸­çš„old_strå­—æ®µä¸ºå½“å‰ä¸­é—´ä»¶é…ç½®ï¼Œnew_strå­—æ®µä¸ºéœ€è¦ä¿®æ”¹åçš„ä¸­é—´ä»¶é…ç½®ï¼Œä»£ç è¿è¡Œå°†settingæ–‡ä»¶ä¸­çš„old_stré…ç½®ä¿®æ”¹æˆnew_stré…ç½®ã€‚</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/26/%E6%B5%B7%E5%A4%96%E6%94%AF%E4%BB%98%E6%B8%A0%E9%81%93%E5%AF%B9%E6%8E%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaozhigang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaozhigang">
      <meta itemprop="description" content="æœ€åä¸çŸ¥å¤©åœ¨æ°´ï¼Œæ»¡èˆ¹æ¸…æ¢¦å‹æ˜Ÿæ²³ã€‚">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | xiaozhigang">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/08/26/%E6%B5%B7%E5%A4%96%E6%94%AF%E4%BB%98%E6%B8%A0%E9%81%93%E5%AF%B9%E6%8E%A5/" class="post-title-link" itemprop="url">æµ·å¤–æ”¯ä»˜æ¸ é“å¯¹æ¥</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2024-08-26 20:26:53 / ä¿®æ”¹æ—¶é—´ï¼š23:25:40" itemprop="dateCreated datePublished" datetime="2024-08-26T20:26:53+08:00">2024-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>â€‹	åœ¨æ–°å…¬å¸ä¸­ï¼Œé‡åˆ°äº†ä¸€ä¸ªä¹‹å‰æ²¡é‡åˆ°è¿‡çš„ä¸šåŠ¡ï¼Œé‚£å°±æ˜¯å¯¹æ¥æµ·å¤–çš„æ”¯ä»˜ã€‚ä¹‹å‰ä¸€ç›´ä»¥ä¸ºç®¡ç†å¯¹æ¥æœ‰ä»€ä¹ˆæŠ€æœ¯é«˜å±±éœ€è¦ç™»é¡¶ï¼Œæ¥è§¦ä¹‹åå‘ç°å¥½åƒä¹Ÿæ²¡å•¥ï¼Œéƒ½æ˜¯å¯¹æ¥æ¥å£ã€‚æŒ‰ç…§å„ç§æ”¯ä»˜å¹³å°æ–‡æ¡£è¦æ±‚å»å¯¹æ¥å°±å¥½ã€‚</p>
<p>â€‹	å‰åå¯¹æ¥è¿‡å‡ ä¸ªå¹³å°çš„æ”¯ä»˜ï¼šAlipayã€PayPalã€Payssionã€Stripe ã€‚æœ€åå‘ç°å¥—è·¯å¥½åƒéƒ½å·®ä¸å¤šã€‚ç›®å‰åº”ç”¨åˆ°çš„æ”¯ä»˜æœ‰ä¸¤ç§æ¨¡å¼ï¼šå•æ¬¡æ”¯ä»˜ã€è®¢é˜…æ”¯ä»˜ã€‚</p>
<h3 id="å•æ¬¡æ”¯ä»˜"><a href="#å•æ¬¡æ”¯ä»˜" class="headerlink" title="å•æ¬¡æ”¯ä»˜"></a>å•æ¬¡æ”¯ä»˜</h3><p>â€‹	å„ä¸ªå¹³å°çš„å•æ¬¡æ”¯ä»˜éƒ½å·®ä¸å¤šï¼Œå¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>â€‹		1ã€<strong>å•†æˆ·ç³»ç»Ÿ</strong> è°ƒç”¨æ”¯ä»˜å¹³å° APIï¼Œç”Ÿæˆæ”¯ä»˜è®¢å•ã€‚</p>
<p>â€‹		2ã€<strong>æ”¯ä»˜å¹³å°</strong> è¿”å›æ”¯ä»˜é“¾æ¥ &#x2F; æ”¯ä»˜é¡µé¢ã€‚</p>
<p>â€‹		3ã€<strong>ç”¨æˆ·</strong> åœ¨æ”¯ä»˜é¡µé¢å®Œæˆæ”¯ä»˜ã€‚</p>
<p>â€‹		4ã€<strong>æ”¯ä»˜å¹³å°</strong> åŒæ­¥&#x2F;å¼‚æ­¥é€šçŸ¥æ”¯ä»˜ç»“æœã€‚</p>
<p>â€‹		5ã€<strong>å•†æˆ·ç³»ç»Ÿ</strong> æ ¹æ®é€šçŸ¥æ›´æ–°è®¢å•çŠ¶æ€ã€‚</p>
<p>â€‹	æ”¯ä»˜å¹³å°å¼‚æ­¥é€šçŸ¥æ”¯ä»˜ç»“æœçš„æ¥å£æœ‰çš„éœ€è¦åœ¨å¹³å°å»æ³¨å†Œï¼Œæœ‰çš„éœ€è¦åœ¨è¯·æ±‚ç”Ÿæˆæ”¯ä»˜è®¢å•çš„æ—¶å€™ä½œä¸ºå‚æ•°ä¼ è¿›å»ã€‚</p>
<table>
<thead>
<tr>
<th>å¹³å°</th>
<th>å‘èµ·æ”¯ä»˜</th>
<th>æ”¯ä»˜é¡µé¢</th>
<th>æ”¯ä»˜å®Œæˆå›è°ƒ</th>
<th>ç‰¹ç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Alipay</strong></td>
<td>å•†æˆ·è°ƒç”¨æ”¯ä»˜å®ä¸‹å•æ¥å£</td>
<td>è·³è½¬æ”¯ä»˜å®æ”¶é“¶å°</td>
<td>æ”¯ä»˜å®å›è°ƒ + å•†æˆ·æŸ¥è¯¢</td>
<td>å›½å†…ä¸»æµï¼Œå¼ºåˆ¶å›è°ƒæœºåˆ¶</td>
</tr>
<tr>
<td><strong>PayPal</strong></td>
<td>å•†æˆ·è°ƒç”¨ <code>create payment</code> API</td>
<td>è·³è½¬ PayPal ç½‘é¡µ&#x2F;APP</td>
<td>PayPal å›è°ƒ + IPN</td>
<td>è·¨å¢ƒå¸¸ç”¨ï¼Œç”¨æˆ·ä½“éªŒå¥½</td>
</tr>
<tr>
<td><strong>Payssion</strong></td>
<td>å•†æˆ·è°ƒç”¨ Payssion API</td>
<td>è·³è½¬åˆ°å¯¹åº”æœ¬åœ°æ”¯ä»˜æ–¹å¼</td>
<td>Payssion å›è°ƒ + æŸ¥è¯¢</td>
<td>èšåˆå¤šå›½æœ¬åœ°æ”¯ä»˜</td>
</tr>
<tr>
<td><strong>Stripe</strong></td>
<td>å•†æˆ·è°ƒç”¨ <code>PaymentIntent</code> API</td>
<td>Stripe Checkout é¡µé¢</td>
<td>Webhook é€šçŸ¥</td>
<td>å¼€å‘è€…å‹å¥½ï¼ŒAPI ç»Ÿä¸€</td>
</tr>
</tbody></table>
<pre class="mermaid">sequenceDiagram
    participant U as ç”¨æˆ·
    participant M as å•†æˆ·ç³»ç»Ÿ
    participant A as æ”¯ä»˜å¹³å°

    rect rgb(230,230,250)
    U->>M: è°ƒç”¨å•†æˆ·æ”¯ä»˜
    M->>A: è°ƒç”¨ç»Ÿä¸€æ”¶å•ä¸‹å•æ¥å£ (å„å¹³å°ä¸åŒ)
    A-->>M: è¿”å›æ”¯ä»˜é“¾æ¥
    M->>U: æ·»åŠ å›è°ƒé¡µé¢è¿”å›ç”¨æˆ·
    U->>A: æ‰“å¼€æ”¯ä»˜é“¾æ¥å®Œæˆæ”¯ä»˜
    A->>M: æ‰“å¼€å›è°ƒé¡µé¢
    A-->>M: å¼‚æ­¥å›è°ƒé€šçŸ¥æ”¯ä»˜ç»“æœ
    M->>A: å¯é€‰ï¼šæŸ¥è¯¢è®¢å•ç¡®è®¤
    end</pre>

<h3 id="è®¢é˜…æ”¯ä»˜"><a href="#è®¢é˜…æ”¯ä»˜" class="headerlink" title="è®¢é˜…æ”¯ä»˜"></a>è®¢é˜…æ”¯ä»˜</h3><p>â€‹	å‡ ä¸ªå¹³å°çš„è®¢é˜…æ”¯ä»˜ï¼Œå°±æœ‰æ‰€ä¸åŒäº†ï¼Œä¸»è¦åˆ†ä¸‰ç§ï¼š</p>
<p>1ã€ä»¥alipayä¸ºä»£è¡¨ï¼Œåœ¨è®¢å•å’Œæˆæƒéƒ½å®Œæˆçš„æƒ…å†µä¸‹ï¼Œæ¯æœŸæ‰£æ¬¾éƒ½éœ€è¦å•†æˆ·ä¸»åŠ¨è°ƒå–ç›¸åº”æ¥å£ã€‚</p>
<p>2ã€ä»¥PayPal &#x2F; Stripeä¸ºä»£è¡¨ï¼Œåœ¨è®¢å•å’Œæˆæƒéƒ½å®Œæˆçš„æƒ…å†µä¸‹ï¼Œæ”¯ä»˜å¹³å°ä¼šæ¯æœŸè‡ªåŠ¨æ‰£æ¬¾ã€‚</p>
<p>3ã€ä»¥Payssionä¸ºä»£è¡¨ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°ç”Ÿæˆè®¢å•ï¼Œé‡èµ°æµç¨‹ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤ã€‚</p>
<pre class="mermaid">sequenceDiagram
    participant User as ç”¨æˆ·
    participant App as å•†æˆ·ç³»ç»Ÿ
    participant Pay as æ”¯ä»˜å¹³å°
    
    Note over User,Pay: è®¢é˜…ç­¾çº¦æµç¨‹

    User->>App: é€‰æ‹©è®¢é˜…
    App->>Pay: åˆ›å»ºç­¾çº¦ / è®¢é˜…è®¡åˆ’
    Pay-->>App: è¿”å›æˆæƒé¡µé¢é“¾æ¥
    App->>User: è·³è½¬åˆ°æˆæƒé¡µé¢
    User->>Pay: ç¡®è®¤æˆæƒï¼ˆå…å¯†ä»£æ‰£ï¼‰
    Pay-->>App: è¿”å›åè®®å·/è®¢é˜…ID
    Pay-->>User: å›è·³åˆ° return_url

    Note over App,Pay: åç»­å‘¨æœŸæ‰£æ¬¾

    alt æ”¯ä»˜å®
        App->>Pay: ä¸»åŠ¨è°ƒç”¨ alipay.trade.create (å¸¦ agreement_no)
        Pay-->>App: è¿”å›æ‰£æ¬¾ç»“æœ + notify
    else PayPal / Stripe
        Pay-->>User: åˆ°æœŸæ—¥è‡ªåŠ¨æ‰£æ¬¾
        Pay-->>App: Webhook é€šçŸ¥ç»“æœ
    else Payssion
        App->>Pay: æ¯æœŸé‡æ–°ç”Ÿæˆæ”¯ä»˜è®¢å•
        User->>Pay: æ‰‹åŠ¨å®Œæˆæ”¯ä»˜
    end</pre>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="ä¸‹ä¸€é¡µ" aria-label="ä¸‹ä¸€é¡µ" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2022 â€“ 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">xiaozhigang</span>
  </div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>


    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.min.js","integrity":"sha256-TtLOdUA8mstPoO6sGvHIGx2ceXrrX4KgIItO06XOn8A="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
